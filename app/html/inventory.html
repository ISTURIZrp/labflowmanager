<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LabFlow Manager - Insumos y Lotes</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    
    <style>
        :root {
            --background-light: #ffffff;
            --background-medium: #f0f4f8;
            --background-dark: #e0e6ec;
            --text-primary: #2c3e50;
            --text-secondary: #607d8b;
            --border-color: #d1d9e6;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --accent-primary: #81d4fa;
            --accent-secondary: #4fc3f7;
            --action-success: #66bb6a;
            --action-error: #ef5350;
            --action-warning: #ffa726;
            --font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --sidebar-width-collapsed: 60px;
            --sidebar-width-expanded: 240px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background-color: var(--background-light); color: var(--text-primary); display: flex; min-height: 100vh; }
        .btn { font-family: var(--font-family); padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-primary { background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary)); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(79, 195, 247, 0.4); }
        .btn-secondary { background-color: var(--background-dark); color: var(--text-primary); }
        .btn-edit { background-color: rgba(79, 195, 247, 0.2); color: var(--accent-secondary); padding: 6px 10px; }
        .btn-delete { background-color: rgba(239, 83, 80, 0.2); color: var(--action-error); padding: 6px 10px; }
        .btn-danger { background-color: var(--action-error); color: white; }
        .btn-danger:hover { background-color: #d32f2f; }
        input, select { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--background-dark); color: var(--text-primary); font-size: 1rem; }
        #app-notification { position: fixed; top: 25px; right: 25px; padding: 12px 25px; border-radius: 8px; color: white; z-index: 2000; opacity: 0; transition: opacity 0.5s ease, transform 0.5s ease; transform: translateX(100%); }
        #app-notification.show { opacity: 1; transform: translateX(0); }
        #app-notification.success { background-color: var(--action-success); }
        #app-notification.error { background-color: var(--action-error); }
        nav#sidebar { width: var(--sidebar-width-collapsed); background: var(--background-medium); display: flex; flex-direction: column; transition: width 0.3s ease; position: fixed; height: 100vh; z-index: 1000; border-right: 1px solid var(--border-color); }
        nav#sidebar:hover { width: var(--sidebar-width-expanded); }
        nav#sidebar header { padding: 1.2rem 1rem; font-weight: 700; text-align: center; border-bottom: 1px solid var(--border-color); background: var(--background-dark); white-space: nowrap; overflow: hidden; font-size: 0; }
        nav#sidebar:hover header { font-size: 1.3rem; }
        #user-info { padding: 1rem 1.2rem; border-top: 1px solid var(--border-color); text-align: center; opacity: 0; height: 0; overflow: hidden; transition: opacity 0.3s ease, height 0.3s ease; }
        nav#sidebar:hover #user-info { opacity: 1; height: auto; padding: 1rem; }
        #user-logout-btn-sidebar { background: transparent; border: 1px solid var(--border-color); padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-top: 8px; }
        nav#sidebar ul { list-style: none; padding: 0; flex-grow: 1; }
        nav#sidebar ul li a { display: flex; align-items: center; color: var(--text-primary); text-decoration: none; padding: 1rem 1.2rem; white-space: nowrap; overflow: hidden; }
        nav#sidebar ul li a .material-symbols-outlined { font-size: 1.6rem; transition: margin-right 0.3s ease; }
        nav#sidebar:hover ul li a .material-symbols-outlined { margin-right: 1rem; }
        nav#sidebar ul li a span.text { display: none; opacity: 0; }
        nav#sidebar:hover ul li a span.text { display: inline; opacity: 1; }
        main#content { flex-grow: 1; margin-left: var(--sidebar-width-collapsed); padding: 2rem 3rem; transition: margin-left 0.3s ease; }
        nav#sidebar:hover + main#content { margin-left: var(--sidebar-width-expanded); }
        .content-wrapper { background-color: var(--background-medium); border: 1px solid var(--border-color); border-radius: 16px; padding: 30px; box-shadow: 0 8px 25px var(--shadow-color); }
        .table-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .users-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .users-table th, .users-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .users-table thead { background: var(--background-dark); }
        .action-buttons { display: flex; gap: 8px; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1500; backdrop-filter: blur(4px); }
        .modal-backdrop.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 500px; position: relative; animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-modal-btn { position: absolute; top: 15px; right: 15px; background: transparent; border: none; font-size: 1.8rem; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        tr.insumo-row { cursor: pointer; }
        tr.lote-row td { padding-left: 30px; background-color: #fafbfc; }
        .dropdown-container { position: relative; display: inline-block; }
        .dropdown-menu { display: none; position: absolute; background-color: var(--background-light); min-width: 180px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; border-radius: 8px; overflow: hidden; border: 1px solid var(--border-color); }
        .dropdown-menu a { color: var(--text-primary); padding: 12px 16px; text-decoration: none; display: block; font-size: 0.9rem; }
        .dropdown-menu a:hover { background-color: var(--background-medium); }
        .dropdown-container.show .dropdown-menu { display: block; }
    </style>
</head>
<body>
    <nav id="sidebar">
        <header>LabFlow</header>
        <ul>
            <li><a href="home.html"><span class="material-symbols-outlined">home</span> <span class="text">Inicio</span></a></li>
            <li><a href="inventory.html"><span class="material-symbols-outlined">inventory_2</span> <span class="text">Insumos</span></a></li>
            <li><a href="productos.html"><span class="material-symbols-outlined">category</span> <span class="text">Productos</span></a></li>
            <li><a href="entradas-salidas.html"><span class="material-symbols-outlined">swap_horiz</span> <span class="text">Entradas/Salidas</span></a></li>
            <li><a href="envios.html"><span class="material-symbols-outlined">local_shipping</span> <span class="text">Envíos</span></a></li>
            <li><a href="equipos.html"><span class="material-symbols-outlined">precision_manufacturing</span> <span class="text">Equipos</span></a></li>
            <li><a href="users.html"><span class="material-symbols-outlined">group</span> <span class="text">Usuarios</span></a></li>
            <li><a href="reportes.html"><span class="material-symbols-outlined">bar_chart</span> <span class="text">Reportes</span></a></li>
        </ul>
        <div id="user-info">
            <div id="user-email-display-sidebar">...</div> 
            <button id="user-logout-btn-sidebar">Cerrar Sesión</button> 
        </div>
    </nav>

    <main id="content">
        <header><h1>Gestión de Insumos y Lotes</h1></header>
        <div class="content-wrapper">
            <div class="table-controls">
                <input type="search" id="searchInput" placeholder="Buscar insumo..." autocomplete="off">
                <div class="dropdown-container" id="csvActionsContainer">
                    <button id="btnCSVActions" class="btn btn-secondary"><span class="material-symbols-outlined">file_present</span> Acciones CSV</button>
                    <div id="csvDropdownMenu" class="dropdown-menu">
                        <a href="#" id="btnExportCSV">Exportar Todo</a>
                        <a href="#" id="btnImportInsumosCSV">Importar Insumos</a>
                        <a href="#" id="btnImportLotesCSV">Importar Lotes</a>
                    </div>
                    <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                </div>
                <!-- BOTÓN PARA ELIMINAR SELECCIONADOS (NUEVO) -->
                <button id="btnDeleteSelected" class="btn btn-danger" style="display: none;"><span class="material-symbols-outlined">delete_sweep</span> Eliminar Seleccionados</button>
                <button id="btnAddProduct" class="btn btn-primary"><span class="material-symbols-outlined">add_box</span> Agregar Insumo/Lote</button>
            </div>
            <table class="users-table" id="tableProducts">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAllCheckbox" title="Seleccionar todo"></th>
                        <th>Nombre Insumo</th>
                        <th>Existencia Total</th>
                        <th>Stock Mínimo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="productTableBody"></tbody>
            </table>
        </div>
    </main>

    <!-- Modal para Añadir/Editar -->
    <div class="modal-backdrop" id="productModal">
        <div class="modal-content">
            <h2 id="modalTitle">Agregar Insumo / Lote</h2>
            <button type="button" class="close-modal-btn material-symbols-outlined">close</button>
            <form id="productForm">
                <input type="hidden" id="insumoIdField">
                <input type="hidden" id="loteIdField">
                <div class="form-group"><label for="nombre">Nombre del Insumo *</label><input type="text" id="nombre" required></div>
                <div class="form-group"><label for="stockMinimo">Stock Mínimo *</label><input type="number" id="stockMinimo" min="0" required></div>
                <hr style="margin: 20px 0; border: 1px solid var(--border-color);">
                <div class="form-group"><label for="lote">Número de Lote</label><input type="text" id="lote"></div>
                <div class="form-group"><label for="fechaCaducidad">Fecha de Caducidad</label><input type="date" id="fechaCaducidad"></div>
                <div class="form-group"><label for="existencia">Existencia del Lote *</label><input type="number" id="existencia" min="0" required></div>
                <div style="text-align: right; margin-top: 20px;"><button type="button" class="btn btn-secondary close-modal-btn">Cancelar</button><button type="submit" class="btn btn-primary" id="saveBtn">Guardar</button></div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmación -->
    <div class="modal-backdrop" id="confirmModal">
        <div class="modal-content" style="max-width: 400px;">
            <h2 id="confirmModalTitle">Confirmar Acción</h2>
            <p id="confirmModalMessage" style="margin-top: 15px; margin-bottom: 25px;"></p>
            <div style="text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
                <button type="button" class="btn btn-secondary" id="confirmCancelBtn">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmOkBtn">Aceptar</button>
            </div>
        </div>
    </div>

    <div id="app-notification"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getFirestore, collection, query, where, orderBy, getDocs, doc, getDoc, addDoc, updateDoc, deleteDoc, runTransaction, writeBatch } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        const firebaseConfig = {
          apiKey: "AIzaSyCxJOpBEXZUo7WrAqDTrlJV_2kJBsL8Ym0",
          authDomain: "labflow-manager.firebaseapp.com",
          projectId: "labflow-manager",
          storageBucket: "labflow-manager.firebasestorage.app",
          messagingSenderId: "742212306654",
          appId: "1:742212306654:web:a53bf890fc63cd5d05e44f",
          measurementId: "G-YVZDBCJR3B"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const userEmailDisplaySidebar = document.getElementById('user-email-display-sidebar');
        const userLogoutBtnSidebar = document.getElementById('user-logout-btn-sidebar');
        const productTableBody = document.getElementById('productTableBody');
        const btnAddProduct = document.getElementById('btnAddProduct');
        const productModal = document.getElementById('productModal');
        const productForm = document.getElementById('productForm');
        const saveBtn = document.getElementById('saveBtn');
        const closeModalBtns = document.querySelectorAll('.close-modal-btn');
        const notificationDiv = document.getElementById('app-notification');
        const confirmModal = document.getElementById('confirmModal');
        const confirmModalMessage = document.getElementById('confirmModalMessage');
        const confirmOkBtn = document.getElementById('confirmOkBtn');
        const confirmCancelBtn = document.getElementById('confirmCancelBtn');
        
        const csvActionsContainer = document.getElementById('csvActionsContainer');
        const btnCSVActions = document.getElementById('btnCSVActions');
        const btnExportCSV = document.getElementById('btnExportCSV');
        const btnImportInsumosCSV = document.getElementById('btnImportInsumosCSV');
        const btnImportLotesCSV = document.getElementById('btnImportLotesCSV');
        const csvFileInput = document.getElementById('csvFileInput');
        let currentImportType = null;

        // Elementos para selección múltiple (NUEVO)
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const btnDeleteSelected = document.getElementById('btnDeleteSelected');

        function showNotification(message, type = 'info') {
            notificationDiv.textContent = message;
            notificationDiv.className = 'show ' + type;
            setTimeout(() => { notificationDiv.className = ''; }, 3000);
        }

        function showConfirm(message) {
            return new Promise((resolve) => {
                confirmModalMessage.textContent = message;
                confirmModal.classList.add('active');
                const onOk = () => { cleanup(); resolve(true); };
                const onCancel = () => { cleanup(); resolve(false); };
                const cleanup = () => {
                    confirmOkBtn.removeEventListener('click', onOk);
                    confirmCancelBtn.removeEventListener('click', onCancel);
                    confirmModal.classList.remove('active');
                };
                confirmOkBtn.addEventListener('click', onOk, { once: true });
                confirmCancelBtn.addEventListener('click', onCancel, { once: true });
            });
        }

        async function fetchAndRenderInsumos() {
            productTableBody.innerHTML = `<tr><td colspan="5">Cargando...</td></tr>`;
            try {
                const insumosQuery = query(collection(db, "insumos"), orderBy("nombre"));
                const insumosSnapshot = await getDocs(insumosQuery);
                
                if (insumosSnapshot.empty) {
                    productTableBody.innerHTML = `<tr><td colspan="5">No hay insumos registrados.</td></tr>`;
                    return;
                }

                let tableHtml = '';
                for (const insumoDoc of insumosSnapshot.docs) {
                    const insumo = { id: insumoDoc.id, ...insumoDoc.data() };
                    const lotesQuery = query(collection(db, "lotes"), where("insumo_id", "==", insumo.id));
                    const lotesSnapshot = await getDocs(lotesQuery);
                    const lotes = lotesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    tableHtml += `
                        <tr class="insumo-row" data-insumo-id="${insumo.id}">
                            <td><input type="checkbox" class="insumo-checkbox" data-id="${insumo.id}"></td>
                            <td><strong>${insumo.nombre}</strong></td>
                            <td>${insumo.existencia_total || 0}</td>
                            <td>${insumo.stock_minimo}</td>
                            <td class="action-buttons">
                                <button class="btn btn-edit" data-action="edit-insumo" data-id="${insumo.id}" data-nombre="${insumo.nombre}" data-stock-minimo="${insumo.stock_minimo}">Editar</button>
                                <button class="btn btn-delete" data-action="delete-insumo" data-id="${insumo.id}" data-nombre="${insumo.nombre}">Eliminar</button>
                            </td>
                        </tr>
                    `;
                    if (lotes.length > 0) {
                        tableHtml += `<tr class="lote-row" data-lote-for="${insumo.id}" style="display:none;"><td colspan="5"><table><thead><tr><th>Lote</th><th>Caducidad</th><th>Existencia</th><th>Acciones</th></tr></thead><tbody>`;
                        lotes.forEach(lote => {
                            tableHtml += `
                                <tr>
                                    <td>${lote.lote || 'N/A'}</td>
                                    <td>${lote.fecha_caducidad || 'N/A'}</td>
                                    <td>${lote.existencia}</td>
                                    <td class="action-buttons">
                                        <button class="btn btn-edit" data-action="edit-lote" data-id="${lote.id}" data-insumo-id="${insumo.id}" data-insumo-nombre="${insumo.nombre}" data-stock-minimo="${insumo.stock_minimo}" data-lote='${JSON.stringify(lote)}'>Editar</button>
                                        <button class="btn btn-delete" data-action="delete-lote" data-id="${lote.id}" data-lote-nombre="${lote.lote || 'este lote'}">Eliminar</button>
                                    </td>
                                </tr>
                            `;
                        });
                        tableHtml += `</tbody></table></td></tr>`;
                    }
                }
                productTableBody.innerHTML = tableHtml;
            } catch (error) {
                console.error("Error cargando insumos:", error);
                showNotification("Error al cargar los insumos.", "error");
                productTableBody.innerHTML = `<tr><td colspan="5">Error al cargar datos.</td></tr>`;
            }
        }

        function openModal(insumo = null, lote = null) {
            productForm.reset();
            const modalTitle = document.getElementById('modalTitle');
            const insumoIdField = document.getElementById('insumoIdField');
            const loteIdField = document.getElementById('loteIdField');
            const nombreInput = document.getElementById('nombre');
            const stockMinimoInput = document.getElementById('stockMinimo');

            if (lote) {
                modalTitle.textContent = "Editar Lote";
                insumoIdField.value = lote.insumo_id;
                loteIdField.value = lote.id;
                nombreInput.value = insumo.nombre;
                nombreInput.disabled = true;
                stockMinimoInput.value = insumo.stock_minimo;
                stockMinimoInput.disabled = true;
                document.getElementById('lote').value = lote.lote;
                document.getElementById('fechaCaducidad').value = lote.fecha_caducidad;
                document.getElementById('existencia').value = lote.existencia;
            } else if (insumo) {
                modalTitle.textContent = "Editar Insumo / Añadir Lote";
                insumoIdField.value = insumo.id;
                loteIdField.value = '';
                nombreInput.value = insumo.nombre;
                nombreInput.disabled = false;
                stockMinimoInput.value = insumo.stock_minimo;
                stockMinimoInput.disabled = false;
            } else {
                modalTitle.textContent = "Agregar Insumo y Lote";
                insumoIdField.value = '';
                loteIdField.value = '';
                nombreInput.disabled = false;
                stockMinimoInput.disabled = false;
            }
            productModal.classList.add('active');
        }

        function closeModal() {
            productModal.classList.remove('active');
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            saveBtn.disabled = true;

            const insumoId = document.getElementById('insumoIdField').value;
            const loteId = document.getElementById('loteIdField').value;
            const data = {
                nombre: document.getElementById('nombre').value.trim(),
                stock_minimo: Number(document.getElementById('stockMinimo').value),
                lote: document.getElementById('lote').value.trim(),
                fecha_caducidad: document.getElementById('fechaCaducidad').value,
                existencia: Number(document.getElementById('existencia').value)
            };

            try {
                if (loteId) {
                    await updateDoc(doc(db, "lotes", loteId), { lote: data.lote, fecha_caducidad: data.fecha_caducidad, existencia: data.existencia });
                } else if (insumoId) {
                    await updateDoc(doc(db, "insumos", insumoId), { nombre: data.nombre, stock_minimo: data.stock_minimo });
                    if (data.lote || data.fecha_caducidad) {
                        await addDoc(collection(db, "lotes"), { insumo_id: insumoId, lote: data.lote, fecha_caducidad: data.fecha_caducidad, existencia: data.existencia, created_at: new Date().toISOString() });
                    }
                } else {
                    const q = query(collection(db, "insumos"), where("nombre", "==", data.nombre));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        showNotification("Error: Ya existe un insumo con este nombre.", "error");
                        saveBtn.disabled = false;
                        return;
                    }
                    await runTransaction(db, async (transaction) => {
                        const newInsumoRef = doc(collection(db, "insumos"));
                        transaction.set(newInsumoRef, { nombre: data.nombre, stock_minimo: data.stock_minimo, existencia_total: data.existencia, created_at: new Date().toISOString() });
                        if (data.lote || data.fecha_caducidad || data.existencia > 0) {
                            const newLoteRef = doc(collection(db, "lotes"));
                            transaction.set(newLoteRef, { insumo_id: newInsumoRef.id, lote: data.lote, fecha_caducidad: data.fecha_caducidad, existencia: data.existencia, created_at: new Date().toISOString() });
                        }
                    });
                }
                
                const finalInsumoId = insumoId || (await getDocs(query(collection(db, "insumos"), where("nombre", "==", data.nombre)))).docs[0].id;
                const lotesQuery = query(collection(db, "lotes"), where("insumo_id", "==", finalInsumoId));
                const lotesSnapshot = await getDocs(lotesQuery);
                const totalExistencia = lotesSnapshot.docs.reduce((sum, doc) => sum + doc.data().existencia, 0);
                await updateDoc(doc(db, "insumos", finalInsumoId), { existencia_total: totalExistencia });

                showNotification("Operación exitosa", "success");
                closeModal();
                await fetchAndRenderInsumos();
            } catch (error) {
                console.error("Error guardando:", error);
                showNotification("Error al guardar: " + error.message, "error");
            } finally {
                saveBtn.disabled = false;
            }
        }

        async function handleDelete(action, id, name) {
            const confirmed = await showConfirm(`¿Seguro que quieres eliminar "${name}"? Esta acción es irreversible.`);
            if (!confirmed) return;

            try {
                if (action === 'delete-insumo') {
                    const lotesQuery = query(collection(db, "lotes"), where("insumo_id", "==", id));
                    const lotesSnapshot = await getDocs(lotesQuery);
                    const batch = writeBatch(db);
                    lotesSnapshot.forEach(doc => batch.delete(doc.ref));
                    batch.delete(doc(db, "insumos", id));
                    await batch.commit();
                } else if (action === 'delete-lote') {
                    const loteRef = doc(db, "lotes", id);
                    const loteSnap = await getDoc(loteRef);
                    const insumoId = loteSnap.data().insumo_id;
                    await deleteDoc(loteRef);

                    const lotesQuery = query(collection(db, "lotes"), where("insumo_id", "==", insumoId));
                    const lotesSnapshot = await getDocs(lotesQuery);
                    const totalExistencia = lotesSnapshot.docs.reduce((sum, doc) => sum + doc.data().existencia, 0);
                    await updateDoc(doc(db, "insumos", insumoId), { existencia_total: totalExistencia });
                }
                showNotification("Eliminado correctamente", "success");
                await fetchAndRenderInsumos();
            } catch (error) {
                console.error("Error eliminando:", error);
                showNotification("Error al eliminar: " + error.message, "error");
            }
        }
        
        async function exportToCSV() {
            showNotification("Generando CSV...", "info");
            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = ["InsumoIDOriginal", "InsumoNombre", "StockMinimo", "NumeroLote", "FechaCaducidad", "ExistenciaLote"];
            csvContent += headers.join(",") + "\r\n";

            try {
                const insumosQuery = query(collection(db, "insumos"), orderBy("nombre"));
                const insumosSnapshot = await getDocs(insumosQuery);
                
                for (const insumoDoc of insumosSnapshot.docs) {
                    const insumo = { id: insumoDoc.id, ...insumoDoc.data() };
                    const lotesQuery = query(collection(db, "lotes"), where("insumo_id", "==", insumo.id));
                    const lotesSnapshot = await getDocs(lotesQuery);

                    if (lotesSnapshot.empty) {
                        const row = [insumo.id_original || insumo.id, insumo.nombre, insumo.stock_minimo, "N/A", "N/A", 0];
                        csvContent += row.map(val => `"${val}"`).join(",") + "\r\n";
                    } else {
                        lotesSnapshot.forEach(loteDoc => {
                            const lote = loteDoc.data();
                            const row = [insumo.id_original || insumo.id, insumo.nombre, insumo.stock_minimo, lote.lote || "", lote.fecha_caducidad || "", lote.existencia];
                            csvContent += row.map(val => `"${val}"`).join(",") + "\r\n";
                        });
                    }
                }

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "inventario_completo.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotification("CSV exportado correctamente.", "success");
            } catch (error) {
                console.error("Error al exportar CSV:", error);
                showNotification("Error al generar el CSV.", "error");
            }
        }

        async function handleCSVFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                if (currentImportType === 'insumos') {
                    await handleInsumosCSVImport(text);
                } else if (currentImportType === 'lotes') {
                    await handleLotesCSVImport(text);
                }
            };
            reader.readAsText(file);
        }

        async function handleInsumosCSVImport(csvText) {
            const rows = csvText.split('\n').slice(1).filter(row => row.trim() !== '');
            if (rows.length === 0) {
                showNotification("El archivo CSV de insumos está vacío.", "warning"); return;
            }
            showNotification(`Importando ${rows.length} insumos...`, "info");
            try {
                const batch = writeBatch(db);
                const existingInsumos = new Map();
                const insumosSnapshot = await getDocs(collection(db, "insumos"));
                insumosSnapshot.forEach(doc => existingInsumos.set(doc.data().nombre.toLowerCase(), doc.id));

                for (const row of rows) {
                    const columns = row.split(',').map(s => s.trim().replace(/"/g, ''));
                    const idOriginal = columns[0];
                    const nombreInsumo = columns[1];
                    const stockMinimo = parseInt(columns[2], 10) || 0;
                    
                    if (!nombreInsumo || !idOriginal || existingInsumos.has(nombreInsumo.toLowerCase())) {
                        console.warn(`Saltando insumo duplicado o inválido: ${nombreInsumo}`);
                        continue;
                    }

                    const newInsumoRef = doc(collection(db, "insumos"));
                    batch.set(newInsumoRef, {
                        nombre: nombreInsumo,
                        stock_minimo: stockMinimo,
                        existencia_total: 0,
                        id_original: idOriginal,
                        created_at: new Date().toISOString()
                    });
                    existingInsumos.set(nombreInsumo.toLowerCase(), newInsumoRef.id);
                }
                await batch.commit();
                showNotification("Insumos importados. Recargando lista...", "success");
                await fetchAndRenderInsumos();
            } catch (error) {
                console.error("Error al importar CSV de insumos:", error);
                showNotification("Error durante la importación de insumos.", "error");
            } finally {
                csvFileInput.value = '';
            }
        }
        
        async function handleLotesCSVImport(csvText) {
            const rows = csvText.split('\n').slice(1).filter(row => row.trim() !== '');
            if (rows.length === 0) {
                showNotification("El archivo CSV de lotes está vacío.", "warning"); return;
            }
            showNotification(`Importando ${rows.length} lotes...`, "info");
            
            try {
                const batch = writeBatch(db);
                const insumosMap = new Map();
                const insumosSnapshot = await getDocs(collection(db, "insumos"));
                insumosSnapshot.forEach(doc => insumosMap.set(doc.data().id_original, doc.id));

                const affectedInsumoIds = new Set();

                for (const row of rows) {
                    const columns = row.split(',').map(s => s.trim().replace(/"/g, ''));
                    
                    const insumoOriginalId = columns[1];
                    const lote = columns[2];
                    const fechaCaducidad = columns[3];
                    const existencia = parseInt(columns[4], 10) || 0;

                    const insumoId = insumosMap.get(insumoOriginalId);

                    if (insumoId) {
                        const newLoteRef = doc(collection(db, "lotes"));
                        batch.set(newLoteRef, {
                            insumo_id: insumoId,
                            lote: lote,
                            fecha_caducidad: fechaCaducidad,
                            existencia: existencia,
                            created_at: new Date().toISOString()
                        });
                        affectedInsumoIds.add(insumoId);
                    } else {
                        console.warn(`No se encontró el insumo con id_original: ${insumoOriginalId} para el lote ${lote}`);
                    }
                }
                await batch.commit();

                for (const id of affectedInsumoIds) {
                    const lotesQuery = query(collection(db, "lotes"), where("insumo_id", "==", id));
                    const lotesSnapshot = await getDocs(lotesQuery);
                    const totalExistencia = lotesSnapshot.docs.reduce((sum, doc) => sum + doc.data().existencia, 0);
                    await updateDoc(doc(db, "insumos", id), { existencia_total: totalExistencia });
                }

                showNotification("Lotes importados correctamente. Recargando lista...", "success");
                await fetchAndRenderInsumos();

            } catch (error) {
                console.error("Error al importar CSV de lotes:", error);
                showNotification("Error durante la importación de lotes.", "error");
            } finally {
                csvFileInput.value = '';
            }
        }

        // LÓGICA PARA SELECCIÓN MÚLTIPLE (NUEVO)
        function updateDeleteSelectedButton() {
            const selectedCheckboxes = document.querySelectorAll('.insumo-checkbox:checked');
            if (selectedCheckboxes.length > 0) {
                btnDeleteSelected.style.display = 'inline-flex';
                btnDeleteSelected.textContent = `Eliminar (${selectedCheckboxes.length}) Seleccionados`;
            } else {
                btnDeleteSelected.style.display = 'none';
            }
        }

        async function handleDeleteSelected() {
            const selectedCheckboxes = document.querySelectorAll('.insumo-checkbox:checked');
            const insumoIdsToDelete = Array.from(selectedCheckboxes).map(cb => cb.dataset.id);

            if (insumoIdsToDelete.length === 0) {
                showNotification("No hay insumos seleccionados.", "warning");
                return;
            }

            const confirmed = await showConfirm(`¿Seguro que quieres eliminar los ${insumoIdsToDelete.length} insumos seleccionados y todos sus lotes?`);
            if (!confirmed) return;

            showNotification("Eliminando insumos...", "info");
            try {
                const batch = writeBatch(db);
                for (const insumoId of insumoIdsToDelete) {
                    // Borrar lotes asociados
                    const lotesQuery = query(collection(db, "lotes"), where("insumo_id", "==", insumoId));
                    const lotesSnapshot = await getDocs(lotesQuery);
                    lotesSnapshot.forEach(doc => batch.delete(doc.ref));
                    // Borrar insumo
                    batch.delete(doc(db, "insumos", insumoId));
                }
                await batch.commit();
                showNotification("Insumos seleccionados eliminados.", "success");
                await fetchAndRenderInsumos();
                updateDeleteSelectedButton();
            } catch (error) {
                console.error("Error en eliminación masiva:", error);
                showNotification("Error al eliminar los insumos.", "error");
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userEmailDisplaySidebar.textContent = user.email;
                fetchAndRenderInsumos();
            } else {
                window.location.href = 'index.html';
            }
        });

        userLogoutBtnSidebar.addEventListener('click', () => signOut(auth));
        btnAddProduct.addEventListener('click', () => openModal());
        closeModalBtns.forEach(btn => btn.addEventListener('click', closeModal));
        productForm.addEventListener('submit', handleFormSubmit);

        productTableBody.addEventListener('click', (e) => {
            const target = e.target;
            const insumoRow = target.closest('.insumo-row');
            const actionButton = target.closest('.btn');

            if (actionButton) {
                e.stopPropagation(); // Evita que el clic en el botón expanda la fila
                const { action, id, nombre, loteNombre } = actionButton.dataset;
                if (action === 'edit-insumo') {
                    openModal({ id, nombre, stock_minimo: actionButton.dataset.stockMinimo });
                } else if (action === 'edit-lote') {
                    const insumoData = {
                        id: actionButton.dataset.insumoId,
                        nombre: actionButton.dataset.insumoNombre,
                        stock_minimo: actionButton.dataset.stockMinimo
                    };
                    const loteData = JSON.parse(actionButton.dataset.lote);
                    openModal(insumoData, { id, ...loteData });
                } else if (action === 'delete-insumo' || action === 'delete-lote') {
                    handleDelete(action, id, nombre || loteNombre);
                }
            } else if (target.classList.contains('insumo-checkbox')) {
                e.stopPropagation(); // Evita que el clic en el checkbox expanda la fila
                updateDeleteSelectedButton();
            } else if (insumoRow) {
                const loteRow = document.querySelector(`[data-lote-for="${insumoRow.dataset.insumoId}"]`);
                if (loteRow) {
                    loteRow.style.display = loteRow.style.display === 'none' ? 'table-row' : 'none';
                }
            }
        });
        
        btnCSVActions.addEventListener('click', (e) => {
            e.stopPropagation();
            csvActionsContainer.classList.toggle('show');
        });

        window.addEventListener('click', (e) => {
            if (!csvActionsContainer.contains(e.target)) {
                csvActionsContainer.classList.remove('show');
            }
        });

        btnExportCSV.addEventListener('click', exportToCSV);
        btnImportInsumosCSV.addEventListener('click', () => {
            currentImportType = 'insumos';
            csvFileInput.click();
            csvActionsContainer.classList.remove('show');
        });
        btnImportLotesCSV.addEventListener('click', () => {
            currentImportType = 'lotes';
            csvFileInput.click();
            csvActionsContainer.classList.remove('show');
        });
        csvFileInput.addEventListener('change', handleCSVFile);

        // Event listeners para selección múltiple (NUEVO)
        selectAllCheckbox.addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.insumo-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
            updateDeleteSelectedButton();
        });

        btnDeleteSelected.addEventListener('click', handleDeleteSelected);

    </script>
</body>
</html>
