<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LabFlow Manager - Entradas y Salidas</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

  <style>
    /* 1. Variables CSS (Copia y pega este bloque en todos tus HTML) */
    :root {
        /* Colores base y de fondo */
        --background-light: #ffffff;
        --background-medium: #f0f4f8;
        --background-dark: #e0e6ec;
        --text-primary: #2c3e50;
        --text-secondary: #607d8b;
        --border-color: #d1d9e6;
        --shadow-color: rgba(0, 0, 0, 0.1);

        --accent-glow-start: rgba(129, 212, 250, 0.6);
        --accent-glow-end: rgba(79, 195, 247, 0.6);
        --accent-primary: #81d4fa;
        --accent-secondary: #4fc3f7;

        --action-success: #66bb6a;
        --action-error: #ef5350;
        --action-info: #42a5f5;
        --action-warning: #ffa726;

        --font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;

        --sidebar-width-collapsed: 60px;
        --sidebar-width-expanded: 240px;
    }

    /* 2. Estilos CSS Globales y Comunes (Copia y pega este bloque en todos tus HTML) */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
        font-family: var(--font-family); /* Usa la nueva fuente */
        background: var(--background-light); /* Fondo principal blanco */
        background-image:
            radial-gradient(ellipse at 10% 90%, var(--accent-glow-start), transparent 50%),
            radial-gradient(ellipse at 90% 10%, var(--accent-glow-end), transparent 50%);
        color: var(--text-primary); /* Texto principal azul oscuro */
        display: flex; /* Para layout de sidebar + contenido */
        min-height: 100vh;
        overflow-x: hidden; /* Evita scroll horizontal */
        animation: fadeIn 1s ease-in-out; /* Animación de entrada suave */
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Estilos para contenedores de página y envoltorios de contenido (reutilizados para modal, etc.) */
    .login-container, .page-container, .main-container, .content-wrapper, #transactionFormContainer {
        background-color: var(--background-medium); /* Fondo gris azulado claro */
        border: 1px solid var(--border-color);
        border-radius: 16px; /* Bordes ligeramente más redondeados */
        padding: 30px; /* Más padding para un aspecto más amplio */
        backdrop-filter: blur(8px); /* Efecto de cristal esmerilado más suave */
        -webkit-backdrop-filter: blur(8px);
        box-shadow: 0 8px 25px var(--shadow-color); /* Sombra suave */
        transition: transform 0.3s ease;
    }
    @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    h1, h2 { color: var(--text-primary); font-weight: 700; }
    p { color: var(--text-secondary); }

    .btn { font-family: var(--font-family); padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: all 0.3s ease, transform 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .btn-primary { background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary)); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(79, 195, 247, 0.4); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-secondary { background-color: var(--background-dark); color: var(--text-primary); border: 1px solid var(--border-color); }
    .btn-secondary:hover { background-color: #dbe2e9; border-color: #c0c6ce; }
    .btn-edit { background-color: rgba(79, 195, 247, 0.2); color: var(--accent-secondary); }
    .btn-edit:hover { background-color: rgba(79, 195, 247, 0.4); }
    .btn-delete { background-color: rgba(239, 83, 80, 0.2); color: var(--action-error); }
    .btn-delete:hover { background-color: rgba(239, 83, 80, 0.4); }
    .btn-info-action {
        background-color: rgba(66, 165, 245, 0.2);
        color: var(--action-info);
    }
    .btn-info-action:hover {
        background-color: rgba(66, 165, 245, 0.4);
    }

    input[type="text"], input[type="email"], input[type="password"], input[type="number"], input[type="date"], input[type="search"], select, textarea { /* Added select, textarea */
        width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--background-dark); color: var(--text-primary); font-size: 1rem; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
    input::placeholder, textarea::placeholder { color: var(--text-secondary); opacity: 0.8; } /* Added textarea */
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent-secondary); box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.3); } /* Added select, textarea */

    /* Mensajes de error en formularios */
    .error-message { color: var(--action-error); font-size: 0.85rem; margin-top: 5px; text-align: left; }

    /* Componentes de la Interfaz: Notificaciones */
    #app-notification { position: fixed; top: 25px; right: 25px; padding: 12px 25px; border-radius: 8px; color: white; z-index: 2000; opacity: 0; transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; transform: translateX(100%); display: flex; align-items: center; justify-content: center; font-size: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    #app-notification.show { opacity: 1; transform: translateX(0); }
    #app-notification.success { background-color: var(--action-success); }
    #app-notification.error { background-color: var(--action-error); }
    #app-notification.info { background-color: var(--action-info); }


    /* --- Estilos Específicos para Páginas de Módulo (inventory.html, entradas-salidas.html, users.html, equipos.html, envios.html, productos.html) --- */
    body {
        display: flex;
        flex-direction: row; /* Sidebar y main en fila */
        align-items: stretch; /* Estira el contenido verticalmente */
        background-image: none; /* Sin glow para un fondo más limpio */
        background-color: var(--background-light); /* Fondo del contenido de la página */
    }

    /* Menú lateral - Estado colapsado por defecto */
    nav#sidebar {
        width: var(--sidebar-width-collapsed);
        background: var(--background-medium); /* Sidebar con fondo medio */
        color: var(--text-primary);
        display: flex;
        flex-direction: column;
        transition: width 0.3s ease-in-out;
        position: fixed;
        height: 100vh;
        overflow: hidden;
        z-index: 1000;
        box-shadow: 2px 0 8px var(--shadow-color);
        border-right: 1px solid var(--border-color); /* Borde derecho sutil */
    }
    nav#sidebar:hover {
        width: var(--sidebar-width-expanded);
    }
    nav#sidebar header {
        padding: 1.2rem 1rem;
        font-weight: 700;
        font-size: 0; /* Oculta el texto por defecto */
        user-select: none;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
        background: var(--background-dark); /* Cabecera del sidebar más oscura */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: font-size 0.3s ease, padding 0.3s ease;
    }
    nav#sidebar:hover header {
        font-size: 1.3rem;
        padding: 1.2rem 1rem;
    }

    #user-info {
        padding: 1rem 1.2rem;
        font-size: 0.9rem;
        border-top: 1px solid var(--border-color);
        text-align: center;
        opacity: 0;
        height: 0;
        overflow: hidden;
        transition: opacity 0.3s ease, height 0.3s ease, padding 0.3s ease;
    }
    nav#sidebar:hover #user-info {
        opacity: 1;
        height: auto;
        padding: 1rem 1.2rem;
    }
    #user-info .material-symbols-outlined {
        font-size: 1.8rem;
        margin-bottom: 0.3rem;
        color: var(--accent-secondary); /* Color de acento para el icono de usuario */
    }
    #user-email-display-sidebar { /* ID específico para el email en sidebar */
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--text-secondary);
    }
    #user-logout-btn-sidebar { /* ID específico para el botón en sidebar */
        background: var(--background-dark); /* Color más oscuro para el botón de logout del sidebar */
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.85rem;
        cursor: pointer;
        margin-top: 8px;
        transition: background-color 0.2s ease, border-color 0.2s ease;
    }
    #user-logout-btn-sidebar:hover {
        background-color: rgba(0,0,0,0.1);
        border-color: rgba(0,0,0,0.3);
    }


    /* Elementos de la lista del menú */
    nav#sidebar ul {
        list-style: none;
        padding: 0;
        margin: 0;
        flex-grow: 1;
        overflow-y: auto;
    }
    nav#sidebar ul li {
        border-bottom: 1px solid var(--border-color);
    }
    nav#sidebar ul li a {
        display: flex;
        align-items: center;
        color: var(--text-primary);
        text-decoration: none;
        padding: 1rem 1.2rem;
        font-weight: 500;
        transition: background-color 0.3s ease;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    nav#sidebar ul li a:hover {
        background: rgba(0,0,0,0.05);
        color: var(--text-primary);
    }
    nav#sidebar ul li a .material-symbols-outlined {
        margin-right: 0;
        font-size: 1.6rem;
        transition: margin-right 0.3s ease;
    }
    nav#sidebar:hover ul li a .material-symbols-outlined {
        margin-right: 1rem;
    }
    nav#sidebar ul li a span.text {
        display: none;
        transition: opacity 0.3s ease;
        opacity: 0;
        width: 0;
    }
    nav#sidebar:hover ul li a span.text {
        display: inline;
        opacity: 1;
        width: auto;
    }

    /* El botón de toggle de la barra lateral está oculto */
    #btnToggleSidebar { display: none; }


    /* Contenido principal de la página de módulo */
    main#content {
        flex-grow: 1;
        margin-left: var(--sidebar-width-collapsed); /* Margen inicial */
        padding: 2rem 3rem 4rem 3rem;
        transition: margin-left 0.3s ease-in-out;
        background-color: var(--background-light); /* Fondo del contenido de la página */
    }
    nav#sidebar:hover + main#content {
        margin-left: var(--sidebar-width-expanded);
    }

    header.page-header {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        user-select: none;
        color: var(--text-primary);
    }
    #btnBackMenu {
        background: var(--background-dark); /* Botón de regreso */
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        font-size: 1rem;
        padding: 0.6rem 1.2rem;
        border-radius: 8px; /* Más redondeado */
        cursor: pointer;
        user-select: none;
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        margin-bottom: 1.5rem;
        transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    #btnBackMenu:hover {
        background: rgba(0,0,0,0.1); /* Ligeramente más oscuro en hover */
        border-color: rgba(0,0,0,0.3);
    }

    .content-wrapper {
        padding: 30px;
    }

    /* Controles de la tabla (buscador y botones de filtro) */
    .table-controls {
        display: flex;
        flex-wrap: wrap; /* Permite que los elementos se envuelvan en pantallas pequeñas */
        gap: 15px; /* Espacio entre los elementos */
        margin-bottom: 1.5rem;
        align-items: center;
    }
    /* El buscador */
    #searchInput {
        flex-grow: 1; /* Permite que el buscador ocupe el espacio disponible */
        min-width: 200px; /* Ancho mínimo para el buscador */
        max-width: 450px;
        font-size: 1rem;
        padding: 0.7rem 1rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background-color: var(--background-dark);
        color: var(--text-primary);
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    #searchInput:focus {
        outline: none;
        border-color: var(--accent-secondary);
        box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.3);
    }
    /* Contenedor de botones de filtro */
    .filter-buttons-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    /* Estilos generales para tablas dentro de content-wrapper */
    table {
        width: 100%;
        margin-top: 30px;
        border-collapse: separate;
        border-spacing: 0;
        box-shadow: 0 4px 15px var(--shadow-color);
        background: var(--background-medium);
        border-radius: 12px;
        overflow: hidden;
    }
    thead {
        background: var(--background-dark);
        color: var(--text-primary);
        font-weight: 700;
    }
    th, td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.9rem;
        color: var(--text-primary);
    }
    th:first-child { border-top-left-radius: 12px; }
    th:last-child { border-top-right-radius: 12px; }
    tbody tr:last-child td {
        border-bottom: none;
    }
    tr:hover {
        background: rgba(0,0,0,0.05);
        cursor: default;
    }

    /* Estilos específicos para la tabla de historial de transacciones */
    #pendingTransactionsTable th, #pendingTransactionsTable td,
    #transactionsHistoryTable th, #transactionsHistoryTable td {
        /* Reutiliza estilos de tabla general */
    }
    .transaction-type.entrada { color: var(--action-success); font-weight: 500; }
    .transaction-type.salida { color: var(--action-error); font-weight: 500; }
    .transaction-type.ajuste { color: var(--action-info); font-weight: 500; }

    /* Estilos para el formulario de transacción única */
    #singleTransactionForm {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 40px;
    }
    #singleTransactionForm .full-width {
        grid-column: span 2;
    }
    #singleTransactionForm label {
        margin-top: 0;
        margin-bottom: 8px;
        font-size: 1rem;
        color: var(--text-primary);
    }
    #singleTransactionForm input, #singleTransactionForm select, #singleTransactionForm textarea {
        margin-top: 0;
        background-color: var(--background-dark);
        color: var(--text-primary);
    }
    #singleTransactionForm .form-group {
        display: flex;
        flex-direction: column;
    }

    #singleTransactionForm .radio-group {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-top: 10px;
    }
    #singleTransactionForm .radio-group label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-size: 1rem;
        color: var(--text-primary);
        font-weight: normal;
        margin-top: 0;
    }
    #singleTransactionForm .radio-group input[type="radio"] {
        width: auto;
        margin: 0;
        accent-color: var(--accent-primary);
        cursor: pointer;
    }

    /* Títulos de sección */
    .section-title {
        font-size: 1.6rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 25px;
    }

    /* Estilos para las tablas (pendiente e historial) */
    #pendingTransactionsTable, #transactionsHistoryTable {
        width: 100%;
        margin-top: 30px;
    }
    #pendingTransactionsTable thead, #transactionsHistoryTable thead {
        background: var(--background-dark);
    }
    #pendingTransactionsTable th, #pendingTransactionsTable td, 
    #transactionsHistoryTable th, #transactionsHistoryTable td {
        padding: 12px 15px;
        font-size: 0.9rem;
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-color);
    }
    #pendingTransactionsTable tbody tr:hover, #transactionsHistoryTable tbody tr:hover {
        background: rgba(0,0,0,0.05);
    }
    #pendingTransactionsTable tbody tr:last-child td, #transactionsHistoryTable tbody tr:last-child td {
        border-bottom: none;
    }

    /* Botones de acción en tablas (eliminar pendiente y eliminar historial) */
    .action-buttons {
        display: flex;
        gap: 8px;
    }
    .action-buttons .btn-remove-pending {
        background-color: rgba(239, 83, 80, 0.2);
        color: var(--action-error);
        padding: 6px 10px;
        font-size: 0.85rem;
        box-shadow: none;
    }
    .action-buttons .btn-remove-pending:hover {
        background-color: rgba(239, 83, 80, 0.4);
    }
    .action-buttons .btn-delete-history { /* Nuevo estilo para eliminar historial */
        background-color: rgba(239, 83, 80, 0.2);
        color: var(--action-error);
        padding: 6px 10px;
        font-size: 0.85rem;
        box-shadow: none;
    }
    .action-buttons .btn-delete-history:hover {
        background-color: rgba(239, 83, 80, 0.4);
    }

    /* Botón Confirmar Todas las Transacciones */
    #confirmAllTransactionsBtn {
        background: var(--action-success);
        color: white;
        font-size: 1.1rem;
        padding: 0.8rem 1.8rem;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
    }
    #confirmAllTransactionsBtn:hover {
        background: #5cb85c;
        transform: translateY(-2px);
    }

    /* Mensajes de carga/vacío en tablas */
    .loading-message, .empty-message {
        text-align: center;
        padding: 1.5rem;
        font-style: italic;
        color: var(--text-secondary);
    }
    .error-message {
        color: var(--action-error);
        text-align: center;
        padding: 1.5rem;
    }

    @media (max-width: 768px) {
        main#content {
            padding: 1.5rem;
        }
        .content-wrapper {
            padding: 20px;
        }
        #singleTransactionForm {
            grid-template-columns: 1fr;
        }
        #singleTransactionForm .full-width {
            grid-column: span 1;
        }
        table thead { display: none; }
        table tr {
            display: block;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            background-color: var(--background-medium);
        }
        table td {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: none;
        }
        table td::before {
            content: attr(data-label);
            font-weight: bold;
            color: var(--text-secondary);
            flex-shrink: 0;
            margin-right: 10px;
        }
        table td:last-child {
            justify-content: flex-end;
            margin-top: 10px;
        }
    }
  </style>
</head>
<body>
  <nav id="sidebar" aria-label="Menú lateral">
    <header>LabFlow Manager</header>
    <ul>
      <li><a href="home.html"><span class="material-symbols-outlined">home</span> <span class="text">Inicio</span></a></li>
      <li><a href="inventory.html"><span class="material-symbols-outlined">inventory_2</span> <span class="text">Insumos</span></a></li>
      <li><a href="entradas-salidas.html"><span class="material-symbols-outlined">fact_check</span> <span class="text">Entradas/Salidas</span></a></li>
      <li><a href="envios.html"><span class="material-symbols-outlined">send</span> <span class="text">Envíos</span></a></li>
      <li><a href="users.html"><span class="material-symbols-outlined">groups</span> <span class="text">Usuarios</span></a></li>
      <li><a href="equipos.html"><span class="material-symbols-outlined">build</span> <span class="text">Equipos</span></a></li>
      <li><a href="reportes.html"><span class="material-symbols-outlined">bar_chart</span> <span class="text">Reportes</span></a></li>
    </ul>
    <div id="user-info">
        <span class="material-symbols-outlined">account_circle</span>
        <div id="user-email-display-sidebar">Verificando sesión...</div> 
        <button id="user-logout-btn-sidebar" class="btn-secondary">Cerrar Sesión</button> 
    </div>
  </nav>

  <main id="content" tabindex="-1">
    <header class="page-header">Gestión de Entradas y Salidas</header>
    <button id="btnBackMenu" class="btn-secondary" title="Volver al menú principal">← Volver al menú</button>

    <div class="content-wrapper">
        <h2 class="section-title">Registrar Transacciones Pendientes</h2>

        <form id="singleTransactionForm">
            <div class="form-group">
                <label for="insumoSelect">Insumo:</label>
                <select id="insumoSelect" required disabled> <option value="">Cargando insumos...</option>
                </select>
                <div id="errorInsumo" class="error-message"></div>
            </div>

            <div class="form-group">
                <label>Tipo de Transacción:</label>
                <div class="radio-group">
                    <label><input type="radio" name="tipoTransaccion" value="entrada" required> Entrada</label>
                    <label><input type="radio" name="tipoTransaccion" value="salida"> Salida</label>
                    <label><input type="radio" name="tipoTransaccion" value="ajuste"> Ajuste</label>
                </div>
                <div id="errorTipo" class="error-message"></div>
            </div>

            <div class="form-group" id="loteSelectGroup">
                <label for="loteSelect">Lote (existente):</label>
                <select id="loteSelect">
                    <option value="">Selecciona un lote</option>
                </select>
                <div id="errorLote" class="error-message"></div>
            </div>

            <div class="form-group" id="nuevoLoteGroup">
                <label for="nuevoLoteInput">Nuevo Lote:</label>
                <input type="text" id="nuevoLoteInput" placeholder="Ingresa un nuevo lote">
                <div id="errorNuevoLote" class="error-message"></div>
            </div>

            <div class="form-group" id="fechaCaducidadNuevoLoteGroup">
                <label for="fechaCaducidadNuevoLote">Caducidad Nuevo Lote:</label>
                <input type="date" id="fechaCaducidadNuevoLote">
                <div id="errorFechaCaducidadNuevoLote" class="error-message"></div>
            </div>

            <div class="form-group">
                <label for="cantidad">Cantidad:</label>
                <input type="number" id="cantidad" min="1" required>
                <div id="errorCantidad" class="error-message"></div>
            </div>

            <div class="form-group">
                <label for="referencia">Referencia (ej. Factura #):</label>
                <input type="text" id="referencia" placeholder="Opcional">
            </div>

            <div class="form-group">
                <label for="ubicacion">Ubicación (opcional):</label>
                <input type="text" id="ubicacion" placeholder="Opcional">
            </div>

            <div class="form-group full-width">
                <label for="comentarios">Comentarios:</label>
                <textarea id="comentarios" rows="3" placeholder="Opcional"></textarea>
            </div>

            <button type="submit" class="btn btn-primary" id="addToListBtn">
                <span class="material-symbols-outlined">add_box</span> Añadir a la Lista
            </button>
        </form>

        <h2 class="section-title" style="margin-top: 40px;">Artículos Pendientes de Confirmar</h2>
        <table id="pendingTransactionsTable">
            <thead>
                <tr>
                    <th>Insumo</th>
                    <th>Lote</th>
                    <th>Caducidad</th>
                    <th>Tipo</th>
                    <th>Cantidad</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="pendingTransactionsTableBody">
                <tr><td colspan="6" class="empty-message">No hay artículos pendientes.</td></tr>
            </tbody>
        </table>
        <button class="btn btn-primary full-width" id="confirmAllTransactionsBtn" style="margin-top: 20px;">
            <span class="material-symbols-outlined">done_all</span> Confirmar Todas las Transacciones
        </button>

        <h2 class="section-title" style="margin-top: 40px;">Historial de Transacciones</h2>
        <table id="transactionsHistoryTable">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Insumo</th>
                    <th>Lote</th>
                    <th>Tipo</th>
                    <th>Cantidad</th>
                    <th>Responsable</th>
                    <th>Acciones</th> </tr>
                    <th>Acciones</th> 
                </tr>
            </thead>
            <tbody id="transactionsHistoryTableBody">
                <tr><td colspan="7" class="loading-message">Cargando historial...</td></tr> </tbody>
                <tr><td colspan="7" class="loading-message">Cargando historial...</td></tr> 
            </tbody>
        </table>
        <div id="history-pagination-loading-message" class="loading-message" style="display: none;">
            Cargando más historial...
        </div>
    </div>
  </main>

  <script type="module">
    // --- Firebase SDKs ---
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { 
        getFirestore, 
        collection, 
        query, 
        where, 
        orderBy, 
        limit, 
        startAfter, 
        getDocs, 
        doc, 
        getDoc, 
        addDoc, 
        updateDoc, 
        runTransaction, 
        writeBatch, 
        deleteDoc, // Importar deleteDoc
        deleteDoc, 
        FieldValue 
    } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    // ** TU OBJETO firebaseConfig DE LA CONSOLA DE FIREBASE **
    const firebaseConfig = {
      apiKey: "AIzaSyCxJOpBEXZUo7WrAqDTrlJV_2kJBsL8Ym0",
      authDomain: "labflow-manager.firebaseapp.com",
      projectId: "labflow-manager",
      storageBucket: "labflow-manager.firebasestorage.app",
      messagingSenderId: "742212306654",
      appId: "1:742212306654:web:a53bf890fc63cd5d05e44f",
      measurementId: "G-YVZDBCJR3B"
    };

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app); 
    const db = getFirestore(app); 

    // --- Elementos DOM ---
    const btnBackMenu = document.getElementById('btnBackMenu');
    const userEmailDisplaySidebar = document.getElementById('user-email-display-sidebar');
    const userLogoutBtnSidebar = document.getElementById('user-logout-btn-sidebar');

    const singleTransactionForm = document.getElementById('singleTransactionForm');
    const insumoSelect = document.getElementById('insumoSelect');
    const loteSelect = document.getElementById('loteSelect');
    const nuevoLoteInput = document.getElementById('nuevoLoteInput');
    const fechaCaducidadNuevoLote = document.getElementById('fechaCaducidadNuevoLote');
    const tipoTransaccionRadios = document.querySelectorAll('input[name="tipoTransaccion"]');
    const cantidadInput = document.getElementById('cantidad');
    const referenciaInput = document.getElementById('referencia');
    const ubicacionInput = document.getElementById('ubicacion');
    const comentariosInput = document.getElementById('comentarios');
    const addToListBtn = document.getElementById('addToListBtn');
    const pendingTransactionsTableBody = document.getElementById('pendingTransactionsTableBody');
    const confirmAllTransactionsBtn = document.getElementById('confirmAllTransactionsBtn');
    const transactionsHistoryTableBody = document.getElementById('transactionsHistoryTableBody');
    const historyPaginationLoadingMessage = document.getElementById('history-pagination-loading-message');

    // Grupos de campos para controlar visibilidad
    const loteSelectGroup = document.getElementById('loteSelectGroup');
    const nuevoLoteGroup = document.getElementById('nuevoLoteGroup');
    const fechaCaducidadNuevoLoteGroup = document.getElementById('fechaCaducidadNuevoLoteGroup');


    // Errores de formulario
    const errorInsumo = document.getElementById('errorInsumo');
    const errorLote = document.getElementById('errorLote');
    const errorNuevoLote = document.getElementById('errorNuevoLote');
    const errorFechaCaducidadNuevoLote = document.getElementById('errorFechaCaducidadNuevoLote');
    const errorTipo = document.getElementById('errorTipo');
    const errorCantidad = document.getElementById('errorCantidad');

    let currentUserEmail = null;
    let isAdmin = false; // Variable para controlar permisos de administrador
    let isAdmin = false; 
    let allInsumosWithLotesCached = []; 
    let pendingTransactions = []; 

    let historyLastVisibleTransaction = null; 
    const HISTORY_ITEMS_PER_PAGE = 5; 
    let historyHasMoreItems = true;
    let isHistoryLoadingMore = false;

    let notificationDiv = document.createElement('div');
    notificationDiv.id = 'app-notification';
    document.body.appendChild(notificationDiv);

    // --- Funciones de Utilidad ---
    function formatDateTime(dateTimeString) {
        if (!dateTimeString) return 'N/A';
        try {
            return new Date(dateTimeString).toLocaleString('es-MX', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        } catch (e) {
            console.warn("Fecha/hora inválida para formatear:", dateTimeString, e);
            return dateTimeString;
        }
    }
    function formatFecha(dateString) { 
        if (!dateString) return 'N/A';
        try {
            const date = new Date(dateString);
            if (isNaN(date)) {
                console.warn("Fecha inválida para formatear:", dateString);
                return dateString;
            }
            return date.toLocaleDateString('es-MX', { year: 'numeric', month: '2-digit', day: '2-digit' });
        } catch (e) {
            console.error("Error al formatear fecha:", dateString, e);
            return dateString;
        }
    }
    function showNotification(message, type = 'info') {
        notificationDiv.textContent = message;
        notificationDiv.className = '';
        notificationDiv.classList.add(type);
        notificationDiv.classList.add('show');
        setTimeout(() => { notificationDiv.classList.remove('show'); }, 3000);
    }

    // --- Control de Navegación y Sesión (Sidebar) ---
    btnBackMenu.addEventListener('click', () => {
      window.location.href = 'home.html'; 
    });

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUserEmail = user.email; 
            const userName = user.displayName || user.email;
            userEmailDisplaySidebar.textContent = userName; 

            // Obtener el rol del usuario
            try {
                const idTokenResult = await user.getIdTokenResult();
                isAdmin = idTokenResult.claims.role === 'administrador';
                console.log('Usuario es administrador:', isAdmin);
            } catch (error) {
                console.error("Error al obtener claims del usuario:", error);
                isAdmin = false; // Por seguridad, si no se puede verificar, no es admin.
                isAdmin = false; 
            }

            await loadAllInsumosAndLotesForForm();
            resetHistoryPaginationAndLoad(); 
        } else {
            console.log('No hay sesión activa de Firebase o ha sido cerrada. Redirigiendo al login...');
            window.location.href = 'index.html';
        }
    });

    async function handleLogout() {
        try {
            await signOut(auth); 
            console.log('Sesión cerrada correctamente.');
        } catch (error) {
            console.error('Error al cerrar sesión:', error.message);
            showNotification('Error al cerrar sesión: ' + error.message, 'error');
        }
    }
    userLogoutBtnSidebar.addEventListener('click', handleLogout);

    // --- Lógica de Carga Única de Insumos y Lotes para el Formulario (Firestore) ---
    async function loadAllInsumosAndLotesForForm() {
        console.time('loadInsumosForForm'); 
        insumoSelect.innerHTML = '<option value="">Cargando insumos...</option>';
        insumoSelect.disabled = true; 
        try {
            const insumosCollection = collection(db, 'insumos');
            const qInsumos = query(insumosCollection, orderBy('nombre', 'asc'));
            const insumosSnapshot = await getDocs(qInsumos);

            allInsumosWithLotesCached = []; 
            if (!insumosSnapshot.empty) {
                for (const insumoDoc of insumosSnapshot.docs) {
                    const insumoData = { id: insumoDoc.id, ...insumoDoc.data() };
                    const lotesCollection = collection(db, 'lotes');
                    const qLotes = query(lotesCollection, where('insumo_id', '==', insumoData.id));
                    const lotesSnapshot = await getDocs(qLotes);
                    insumoData.lotes = lotesSnapshot.docs.map(loteDoc => ({ id: loteDoc.id, ...loteDoc.data() }));
                    allInsumosWithLotesCached.push(insumoData);
                }
            }

            let optionsHtml = '<option value="">Selecciona un insumo</option>';
            if (allInsumosWithLotesCached.length === 0) {
                optionsHtml = '<option value="">No hay insumos disponibles</option>';
                showNotification('No se encontraron insumos. Agrega algunos en el módulo de Inventario.', 'warning');
            } else {
                allInsumosWithLsumosCached.forEach(insumo => { // Corregido: allInsumosWithLotesCached
                allInsumosWithLotesCached.forEach(insumo => { 
                    optionsHtml += `<option value="${insumo.id}">${insumo.nombre}</option>`;
                });
            }
            insumoSelect.innerHTML = optionsHtml;
            insumoSelect.disabled = false; 
            updateLoteFieldsVisibility(); 
            showNotification('Insumos cargados correctamente.', 'success'); 
        } catch (error) {
            console.error('Error al cargar insumos y lotes para el formulario:', error);
            showNotification('Error al cargar insumos y lotes para el formulario: ' + error.message, 'error');
            insumoSelect.innerHTML = '<option value="">Error al cargar insumos</option>';
            insumoSelect.disabled = true; 
        } finally {
            console.timeEnd('loadInsumosForForm'); 
        }
    }


    // --- Lógica del Formulario de Una Sola Línea y Carrito ---

    // Maneja la selección de insumo para cargar lotes y ajustar campos del formulario
    insumoSelect.addEventListener('change', () => {
        const selectedInsumoId = insumoSelect.value;
        const selectedInsumo = allInsumosWithLotesCached.find(i => i.id === selectedInsumoId);

        // Reiniciar campos de lote y nuevo lote
        loteSelect.innerHTML = '<option value="">Selecciona un lote</option>';
        nuevoLoteInput.value = '';
        fechaCaducidadNuevoLote.value = '';

        if (selectedInsumo) {
            const currentTipo = document.querySelector('input[name="tipoTransaccion"]:checked')?.value;
            let loteOptionsHtml = '<option value="">Selecciona un lote</option>';

            if (currentTipo === 'entrada') {
                loteOptionsHtml += '<option value="NUEVO_LOTE">-- Registrar nuevo lote --</option>';
            }

            selectedInsumo.lotes.forEach(lote => {
                const caducidad = lote.fecha_caducidad ? ` (Cad: ${formatFecha(lote.fecha_caducidad)})` : '';
                loteOptionsHtml += `<option value="${lote.id}">Lote: ${lote.lote || 'N/A'} - Disp: ${lote.existencia || 0}${caducidad}</option>`;
            });
            loteSelect.innerHTML = loteOptionsHtml;
        }

        updateLoteFieldsVisibility(); 
    });

    // Actualizar campos de lote/nuevo lote basados en el tipo de transacción y selección de lote
    function updateLoteFieldsVisibility() {
        const selectedTipo = document.querySelector('input[name="tipoTransaccion"]:checked')?.value;
        const selectedInsumoId = insumoSelect.value;
        const selectedLoteOption = loteSelect.value;

        // Limpiar errores y ocultar/deshabilitar por defecto
        clearFormErrors(); 
        loteSelectGroup.style.display = 'none'; 
        loteSelect.disabled = true; 
        nuevoLoteGroup.style.display = 'none';
        fechaCaducidadNuevoLoteGroup.style.display = 'none';
        nuevoLoteInput.required = false;
        fechaCaducidadNuevoLote.required = false;

        if (!selectedInsumoId) {
            return;
        }

        loteSelectGroup.style.display = 'flex'; 
        loteSelect.disabled = false; 

        const selectedInsumo = allInsumosWithLotesCached.find(i => i.id === selectedInsumoId);
        if (selectedInsumo) {
            let loteOptionsHtml = '<option value="">Selecciona un lote</option>';
            if (selectedTipo === 'entrada') {
                loteOptionsHtml += '<option value="NUEVO_LOTE">-- Registrar nuevo lote --</option>';
            }
            selectedInsumo.lotes.forEach(lote => {
                const caducidad = lote.fecha_caducidad ? ` (Cad: ${formatFecha(lote.fecha_caducidad)})` : '';
                loteOptionsHtml += `<option value="${lote.id}">Lote: ${lote.lote || 'N/A'} - Disp: ${lote.existencia || 0}${caducidad}</option>`;
            });
            const currentLoteValue = loteSelect.value; 
            loteSelect.innerHTML = loteOptionsHtml;

            if ((selectedTipo === 'salida' || selectedTipo === 'ajuste') && currentLoteValue === 'NUEVO_LOTE') {
                loteSelect.value = ''; 
            } else {
                loteSelect.value = currentLoteValue;
            }
        }

        if (selectedTipo === 'entrada') {
            if (loteSelect.value === 'NUEVO_LOTE') {
                nuevoLoteGroup.style.display = 'flex';
                fechaCaducidadNuevoLoteGroup.style.display = 'flex';
                nuevoLoteInput.required = true;
                fechaCaducidadNuevoLote.required = true;
            } else {
                nuevoLoteInput.value = ''; 
                fechaCaducidadNuevoLote.value = '';
            }
        } else if (selectedTipo === 'salida' || selectedTipo === 'ajuste') {
            nuevoLoteInput.value = '';
            fechaCaducidadNuevoLote.value = '';
            if (loteSelect.value === 'NUEVO_LOTE') { 
                loteSelect.value = ''; 
            }
        } else {
            loteSelectGroup.style.display = 'none';
            loteSelect.value = '';
            nuevoLoteInput.value = '';
            fechaCaducidadNuevoLote.value = '';
        }
    }

    function clearFormErrors() {
        errorInsumo.textContent = '';
        errorLote.textContent = '';
        errorNuevoLote.textContent = '';
        errorFechaCaducidadNuevoLote.textContent = '';
        errorTipo.textContent = '';
        errorCantidad.textContent = '';
    }

    tipoTransaccionRadios.forEach(radio => {
        radio.addEventListener('change', updateLoteFieldsVisibility);
    });

    loteSelect.addEventListener('change', updateLoteFieldsVisibility);

    function validateSingleTransactionForm() {
        clearFormErrors();
        let isValid = true;

        const insumoId = insumoSelect.value;
        const tipoTransaccion = document.querySelector('input[name="tipoTransaccion"]:checked')?.value;
        const cantidad = parseInt(cantidadInput.value);

        if (!insumoId) { errorInsumo.textContent = 'Selecciona un insumo.'; isValid = false; }
        if (!tipoTransaccion) { errorTipo.textContent = 'Selecciona un tipo de transacción.'; isValid = false; }
        if (isNaN(cantidad) || cantidad <= 0) { errorCantidad.textContent = 'Cantidad debe ser un número positivo.'; isValid = false; }

        if (!isValid) return false; 

        const selectedLoteOption = loteSelect.value;
        const selectedInsumo = allInsumosWithLotesCached.find(i => i.id === insumoId);

        if (tipoTransaccion === 'entrada') {
            if (selectedLoteOption === 'NUEVO_LOTE') {
                const nuevoLoteVal = nuevoLoteInput.value.trim();
                const fechaCadVal = fechaCaducidadNuevoLote.value;
                if (!nuevoLoteVal) { errorNuevoLote.textContent = 'Nombre de lote es obligatorio.'; isValid = false; }
                if (!fechaCadVal) { errorFechaCaducidadNuevoLote.textContent = 'Fecha de caducidad es obligatoria.'; isValid = false; }
                if (fechaCadVal) {
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    const cadDate = new Date(fechaCadVal);
                    cadDate.setHours(0,0,0,0);
                    if (cadDate < today) {
                        errorFechaCaducidadNuevoLote.textContent = 'La fecha de caducidad no puede ser en el pasado.'; isValid = false;
                    }
                }
            } 
        } else if (tipoTransaccion === 'salida' || tipoTransaccion === 'ajuste') {
            if (!selectedLoteOption || selectedLoteOption === 'NUEVO_LOTE') { 
                errorLote.textContent = 'Debes seleccionar un lote existente para esta operación.'; isValid = false;
            } else {
                const selectedLote = selectedInsumo.lotes.find(l => l.id === selectedLoteOption);
                if (!selectedLote) { 
                     errorLote.textContent = 'Lote no válido o no encontrado.'; isValid = false;
                } else if (tipoTransaccion === 'salida' && cantidad > selectedLote.existencia) {
                    errorCantidad.textContent = `Cantidad insuficiente. Disponible: ${selectedLote.existencia}`; isValid = false;
                }
            }
        }

        return isValid;
    }


    // Maneja la adición de un item a la lista pendiente
    singleTransactionForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        addToListBtn.disabled = true; 

        if (!validateSingleTransactionForm()) {
            addToListBtn.disabled = false;
            showNotification('Por favor, corrige los errores antes de añadir a la lista.', 'error');
            return;
        }

        const insumoId = insumoSelect.value;
        const insumoNombre = insumoSelect.options[insumoSelect.selectedIndex]?.textContent;
        const tipoTransaccion = document.querySelector('input[name="tipoTransaccion"]:checked')?.value;
        const cantidad = parseInt(cantidadInput.value);
        const referencia = referenciaInput.value.trim() || null;
        const ubicacion = ubicacionInput.value.trim() || null;
        const comentarios = comentariosInput.value.trim() || null;

        let loteIdForPending = loteSelect.value; 
        let loteNombreForPending = '';
        let loteCaducidadForPending = '';

        if (loteIdForPending === 'NUEVO_LOTE') {
            loteNombreForPending = nuevoLoteInput.value.trim();
            loteCaducidadForPending = fechaCaducidadNuevoLote.value; 
        } else if (loteIdForPending) { 
            const selectedInsumo = allInsumosWithLotesCached.find(i => i.id === insumoId);
            const selectedLote = selectedInsumo?.lotes?.find(l => l.id === loteIdForPending);
            loteNombreForPending = selectedLote?.lote || 'N/A';
            loteCaducidadForPending = selectedLote?.fecha_caducidad || null;
        } else { 
            loteIdForPending = null; 
            loteNombreForPending = 'N/A';
            loteCaducidadForPending = null; 
        }

        pendingTransactions.push({
            tempId: Date.now() + Math.random(), 
            insumo_id: insumoId,
            insumo_nombre: insumoNombre,
            lote_id_temp: loteIdForPending, 
            lote_nombre_display: loteNombreForPending, 
            lote_caducidad_display: loteCaducidadForPending, 
            tipo: tipoTransaccion,
            cantidad: cantidad,
            referencia: referencia,
            ubicacion: ubicacion,
            comentarios: comentarios,
            responsable: currentUserEmail 
        });

        renderPendingTransactions();
        singleTransactionForm.reset();
        insumoSelect.value = ''; 
        loteSelect.innerHTML = '<option value="">Selecciona un lote</option>'; 
        nuevoLoteInput.value = '';
        fechaCaducidadNuevoLote.value = '';
        updateLoteFieldsVisibility(); 

        addToListBtn.disabled = false;
        confirmAllTransactionsBtn.disabled = pendingTransactions.length === 0;

        showNotification('Artículo añadido a la lista pendiente.', 'info');
    });


    // Renderiza la tabla de transacciones pendientes
    function renderPendingTransactions() {
        if (pendingTransactions.length === 0) {
            pendingTransactionsTableBody.innerHTML = '<tr><td colspan="6" class="empty-message">No hay artículos pendientes.</td></tr>';
            confirmAllTransactionsBtn.disabled = true;
            return;
        }

        let html = '';
        pendingTransactions.forEach(item => {
            const tipoClass = item.tipo === 'entrada' ? 'entrada' : (item.tipo === 'salida' ? 'salida' : 'ajuste');
            html += `
                <tr data-temp-id="${item.tempId}">
                    <td>${item.insumo_nombre}</td>
                    <td>${item.lote_nombre_display || 'N/A'}</td>
                    <td>${formatFecha(item.lote_caducidad_display) || 'N/A'}</td>
                    <td class="transaction-type ${tipoClass}">${item.tipo.charAt(0).toUpperCase() + item.tipo.slice(1)}</td>
                    <td>${item.cantidad}</td>
                    <td>
                        <button class="btn-delete btn-remove-pending" data-temp-id="${item.tempId}" title="Quitar de la lista">
                            <span class="material-symbols-outlined">remove_circle_outline</span>
                        </button>
                    </td>
                </tr>
            `;
        });
        pendingTransactionsTableBody.innerHTML = html;
        confirmAllTransactionsBtn.disabled = false;

        // Delegación de eventos para botones de remover de la lista pendiente
    }
    pendingTransactionsTableBody.addEventListener('click', (e) => {
        if (e.target.closest('.btn-remove-pending')) {
            const tempIdToRemove = parseFloat(e.target.closest('.btn-remove-pending').dataset.tempId);
            pendingTransactions = pendingTransactions.filter(item => item.tempId !== tempIdToRemove);
            renderPendingTransactions();
            showNotification('Artículo eliminado de la lista pendiente.', 'info');
        }
    });


    // Maneja la confirmación de todas las transacciones pendientes (Firestore)
    confirmAllTransactionsBtn.addEventListener('click', async () => {
        if (pendingTransactions.length === 0) {
            showNotification('No hay artículos pendientes para confirmar.', 'warning');
            return;
        }

        confirmAllTransactionsBtn.disabled = true;
        let successCount = 0;
        let errorCount = 0;

        // Iterar y procesar cada transacción pendiente
        for (const item of pendingTransactions) {
            try {
                // Usar un batch para las escrituras de historial para cada item dentro del bucle
                // Esto es diferente a un batch general para todo. Podríamos usar un solo batch al final.
                // Sin embargo, para mayor claridad y debido a la complejidad de runTransaction,
                // mantendremos la lógica de runTransaction por item y añadiremos el historial al batch final.
                // RECOMENDACIÓN: Si necesitas más atomicidad entre batch y transacción, envolver todo en una función de nube.
                
                let actualLoteId = item.lote_id_temp; 
                let currentLoteRef = null;
                let currentInsumoRef = null; 

                // 1. Si es un nuevo lote ("NUEVO_LOTE"), crearlo y obtener su ID
                if (item.lote_id_temp === 'NUEVO_LOTE') {
                    currentLoteRef = doc(collection(db, 'lotes')); 
                    const newLoteData = {
                        insumo_id: item.insumo_id,
                        lote: item.lote_nombre_display,
                        fecha_caducidad: item.lote_caducidad_display,
                        existencia: 0, 
                        created_at: FieldValue.serverTimestamp() // Usar serverTimestamp
                    };
                    // No lo añadimos directamente al batch principal todavía, se manejará en la transacción atómica
                    // o se creará aquí y luego se actualizará en la transacción.
                    // Para simplificar, asumiremos que runTransaction puede crear el documento.
                    // Pero para set(), si el documento no existe, lo crea.
                    // Para un nuevo lote, es más claro crearlo fuera de la transacción atómica si no se actualiza en el mismo loop.

                    // Para que `runTransaction` pueda actualizar un documento recién creado, este debe existir
                    // o debes manejar la creación dentro de `runTransaction` con `set()`
                    // Aquí, una forma simple es dejar que `set()` dentro del runTransaction lo cree si no existe.
                    // Si ya existe (no es un nuevo lote), `update()` funciona.

                    // La forma más robusta para NUEVOS lotes dentro de una transacción atómica sería:
                    // 1. Crear el ID del nuevo documento de lote: `const newLoteRef = doc(collection(db, 'lotes'));`
                    // 2. Establecer sus datos dentro de la transacción: `transaction.set(newLoteRef, newLoteData);`
                    // 3. Usar `newLoteRef.id` como `actualLoteId`.
                    // Esto evita un compromiso prematuro antes de la transacción principal.
                    
                    // Ajuste para manejar la creación de nuevo lote de forma atómica
                    await runTransaction(db, async (transaction) => {
                        const newLoteRef = doc(collection(db, 'lotes')); // Generar un ID de documento nuevo
                        const newLoteRef = doc(collection(db, 'lotes')); 
                        const newLoteDocData = {
                            insumo_id: item.insumo_id,
                            lote: item.lote_nombre_display,
                            fecha_caducidad: item.lote_caducidad_display,
                            existencia: 0, // Se actualizará con la transacción
                            created_at: FieldValue.serverTimestamp() // Usar serverTimestamp
                            existencia: 0, 
                            created_at: FieldValue.serverTimestamp() 
                        };
                        transaction.set(newLoteRef, newLoteDocData); // Crear el nuevo documento de lote
                        actualLoteId = newLoteRef.id; // Asignar el ID real
                        transaction.set(newLoteRef, newLoteDocData); 
                        actualLoteId = newLoteRef.id; 

                        // Luego, procede con las actualizaciones de existencia usando actualLoteId
                        currentLoteRef = newLoteRef; // Usa la referencia del nuevo lote
                        currentLoteRef = newLoteRef; 
                        currentInsumoRef = doc(db, 'insumos', item.insumo_id);

                        const insumoDoc = await transaction.get(currentInsumoRef);
                        if (!insumoDoc.exists()) {
                            throw "Documento de insumo no existe para la transacción de nuevo lote.";
                        }

                        const oldInsumoTotalExistencia = insumoDoc.data().existencia_total || 0;
                        let newInsumoTotalExistencia = oldInsumoTotalExistencia;

                        if (item.tipo === 'entrada') {
                            newInsumoTotalExistencia += item.cantidad;
                        } else if (item.tipo === 'salida') { // Esto no debería ocurrir con NUEVO_LOTE
                            // Error: No se puede sacar de un lote nuevo sin existencia inicial
                        } else if (item.tipo === 'salida' || item.tipo === 'ajuste') { 
                            throw "No se puede registrar una salida o ajuste negativo de un lote recién creado.";
                        } else if (item.tipo === 'ajuste') { // Esto no debería ocurrir con NUEVO_LOTE
                            // Error: Un ajuste a un lote nuevo debería ser el valor inicial, que es 0 antes de la entrada.
                            throw "No se puede realizar un ajuste en un lote recién creado de esta manera.";
                        }
                        transaction.update(currentInsumoRef, { existencia_total: newInsumoTotalExistencia });
                        transaction.update(currentLoteRef, { existencia: item.cantidad }); // El nuevo lote empieza con la cantidad de entrada
                        transaction.update(currentLoteRef, { existencia: item.cantidad }); 
                    });

                    // Actualizar allInsumosWithLotesCached con el nuevo lote creado (para UI inmediata)
                    const parentInsumo = allInsumosWithLotesCached.find(i => i.id === item.insumo_id);
                    if (parentInsumo) {
                        if (!parentInsumo.lotes) parentInsumo.lotes = [];
                        parentInsumo.lotes.push({
                            id: actualLoteId, 
                            lote: item.lote_nombre_display,
                            fecha_caducidad: item.lote_caducidad_display,
                            existencia: item.cantidad // Actualiza la caché con la cantidad inicial
                            existencia: item.cantidad 
                        });
                    }

                } else if (item.lote_id_temp) { // Lote existente, actualizarlo de forma atómica
                } else if (item.lote_id_temp) { 
                    currentLoteRef = doc(db, 'lotes', actualLoteId);
                    currentInsumoRef = doc(db, 'insumos', item.insumo_id);

                    await runTransaction(db, async (transaction) => {
                        const loteDoc = await transaction.get(currentLoteRef);
                        const insumoDoc = await transaction.get(currentInsumoRef);

                        if (!loteDoc.exists() || !insumoDoc.exists()) {
                            throw "Documento de lote o insumo no existe para la transacción.";
                        }

                        const oldLoteExistencia = loteDoc.data().existencia || 0;
                        const oldInsumoTotalExistencia = insumoDoc.data().existencia_total || 0;
                        let newLoteExistencia = oldLoteExistencia;
                        let newInsumoTotalExistencia = oldInsumoTotalExistencia;

                        if (item.tipo === 'entrada') {
                            newLoteExistencia += item.cantidad;
                            newInsumoTotalExistencia += item.cantidad;
                        } else if (item.tipo === 'salida') {
                            if (oldLoteExistencia < item.cantidad) {
                                throw `Cantidad insuficiente en lote ${item.lote_nombre_display}. Disponible: ${oldLoteExistencia}, Solicitado: ${item.cantidad}`;
                            }
                            newLoteExistencia -= item.cantidad;
                            newInsumoTotalExistencia -= item.cantidad;
                        } else if (item.tipo === 'ajuste') {
                            // Asumiendo que `cantidad` en 'ajuste' es el DELTA (+/-)
                            newLoteExistencia += item.cantidad; 
                            newInsumoTotalExistencia += item.cantidad;
                            // Actualizar la caché del lote también
                            const cachedLote = allInsumosWithLotesCached
                                .find(i => i.id === item.insumo_id)?.lotes
                                .find(l => l.id === item.lote_id_temp);
                            if (cachedLote) {
                                cachedLote.existencia = newLoteExistencia;
                            }
                        }

                        transaction.update(currentLoteRef, { existencia: newLoteExistencia });
                        transaction.update(currentInsumoRef, { existencia_total: newInsumoTotalExistencia });
                    });
                } else { // Caso de transacción sin lote específico (ej. ajuste directo al insumo total si se permitiera)
                    // Esta lógica no está totalmente definida en tu código,
                    // pero si se permite, aquí iría la actualización directa del insumo.
                } else { 
                    console.warn("Transacción sin lote especificado (no es nuevo lote). Solo se registrará en historial.");
                }

                // 2. Registrar la transacción en transacciones_inventario (usando un batch para todas las transacciones de historial)
                // Se crea un nuevo batch para el historial para no mezclar con runTransaction
                const historyBatch = writeBatch(db);
                const transactionData = {
                    insumo_id: item.insumo_id,
                    lote_id: actualLoteId || null, 
                    tipo: item.tipo,
                    cantidad: item.cantidad,
                    referencia: item.referencia,
                    responsable: currentUserEmail,
                    responsable: currentUserEmail, // El email del usuario logueado
                    comentarios: item.comentarios,
                    ubicacion: item.ubicacion,
                    created_at: FieldValue.serverTimestamp() // Usar serverTimestamp
                    created_at: FieldValue.serverTimestamp() 
                };
                historyBatch.set(doc(collection(db, 'transacciones_inventario')), transactionData);
                await historyBatch.commit(); // Confirmar el batch de historial para cada item individualmente por ahora
                                            // Esto asegura que cada historial se guarde tras su operación atómica.
                                            // Se podría recopilar todos los doc() y hacer un solo batch.commit() al final.
                await historyBatch.commit(); 

                successCount++;
            } catch (error) {
                console.error('Error al procesar item de transacción:', item, error);
                errorCount++;
                showNotification(`Falló el registro de un item (${item.insumo_nombre}): ${error.message}`, 'error');
            }
        }

        // --- Resumen de la operación ---
        if (successCount > 0 && errorCount === 0) {
            showNotification(`Se confirmaron ${successCount} transacciones exitosamente.`, 'success');
        } else if (successCount > 0 && errorCount > 0) {
            showNotification(`Se confirmaron ${successCount} transacciones. Fallaron ${errorCount}.`, 'warning');
        } else if (successCount === 0 && errorCount > 0) {
            showNotification(`Fallaron todas las ${errorCount} transacciones. Revisa la consola.`, 'error');
        } else {
             showNotification('No se procesó ninguna transacción.', 'info');
        }

        pendingTransactions = []; 
        renderPendingTransactions(); 
        await resetHistoryPaginationAndLoad(); 
        await loadAllInsumosAndLotesForForm(); 

        confirmAllTransactionsBtn.disabled = false;
    });

    // --- Carga y Renderizado del Historial de Transacciones (Paginación con Firestore) ---

    async function resetHistoryPaginationAndLoad() {
        historyLastVisibleTransaction = null; 
        historyHasMoreItems = true;
        transactionsHistoryTableBody.innerHTML = '<tr><td colspan="7" class="loading-message">Cargando historial...</td></tr>'; // Colspan ajustado
        transactionsHistoryTableBody.innerHTML = '<tr><td colspan="7" class="loading-message">Cargando historial...</td></tr>'; 
        await fetchAndRenderNextHistoryPage(true); 
    }

    async function fetchAndRenderNextHistoryPage(clearExistingHTML = false) {
        if (!historyHasMoreItems || isHistoryLoadingMore) return;

        isHistoryLoadingMore = true;
        historyPaginationLoadingMessage.style.display = 'block';

        try {
            let historyQuery = query(collection(db, 'transacciones_inventario'), orderBy('created_at', 'desc'));

            if (historyLastVisibleTransaction) {
                historyQuery = query(historyQuery, startAfter(historyLastVisibleTransaction));
            }

            historyQuery = query(historyQuery, limit(HISTORY_ITEMS_PER_PAGE));
            const transactionsSnapshot = await getDocs(historyQuery);

            if (clearExistingHTML) {
                transactionsHistoryTableBody.innerHTML = ''; 
            }

            const newTransactions = [];
            let lastDoc = null;
            if (!transactionsSnapshot.empty) {
                for (const transactionDoc of transactionsSnapshot.docs) {
                    const transactionData = { id: transactionDoc.id, ...transactionDoc.data() };

                    const insumoRef = doc(db, 'insumos', transactionData.insumo_id);
                    const insumoSnap = await getDoc(insumoRef);
                    transactionData.insumo_nombre_display = insumoSnap.exists() ? insumoSnap.data().nombre : 'Insumo Eliminado';

                    if (transactionData.lote_id) {
                        const loteRef = doc(db, 'lotes', transactionData.lote_id);
                        const loteSnap = await getDoc(loteRef);
                        transactionData.lote_info_display = loteSnap.exists() ? 
                            `Lote: ${loteSnap.data().lote || 'N/A'} (Cad: ${formatFecha(loteSnap.data().fecha_caducidad)})` : 'Lote Eliminado';
                    } else {
                        transactionData.lote_info_display = 'N/A';
                    }

                    // --- CAMBIO AQUI: Obtener el nombre de usuario del responsable ---
                    let responsableDisplayName = transactionData.responsable || 'N/A'; // Por defecto, usa el email si no hay displayName
                    if (transactionData.responsable) {
                         // Asume que `responsable` es el email del usuario
                         // Si necesitas el displayName completo, deberías buscarlo en la colección de usuarios
                         // o en los claims del token si el usuario actual es el responsable.
                         // Para simplificar, si currentUserEmail es el responsable, usa su displayName.
                         // Si no, muestra el email.
                         if (transactionData.responsable === auth.currentUser?.email) {
                             responsableDisplayName = auth.currentUser.displayName || auth.currentUser.email;
                         } else {
                             responsableDisplayName = transactionData.responsable; // Muestra el email guardado en la transacción
                         }
                    }
                    transactionData.responsable_display = responsableDisplayName;
                    // --- FIN CAMBIO AQUI ---

                    newTransactions.push(transactionData);
                    lastDoc = transactionDoc;
                }
                historyLastVisibleTransaction = lastDoc; 
            }

            if (newTransactions.length > 0) {
                renderTransactionsHistoryTable(newTransactions, true); 
            } else {
                historyHasMoreItems = false;
                if (transactionsHistoryTableBody.children.length === 0) { 
                    transactionsHistoryTableBody.innerHTML = '<tr><td colspan="7" class="empty-message">No hay transacciones registradas.</td></tr>'; // Colspan ajustado
                    transactionsHistoryTableBody.innerHTML = '<tr><td colspan="7" class="empty-message">No hay transacciones registradas.</td></tr>'; 
                }
            }

            if (transactionsSnapshot.docs.length < HISTORY_ITEMS_PER_PAGE) {
                historyHasMoreItems = false; 
            }

        } catch (error) {
            console.error('Error al cargar más historial:', error);
            if (clearExistingHTML) {
                transactionsHistoryTableBody.innerHTML = `<tr><td colspan="7" class="error-message">Error al cargar historial: ${error.message}</td></tr>`; // Colspan ajustado
                transactionsHistoryTableBody.innerHTML = `<tr><td colspan="7" class="error-message">Error al cargar historial: ${error.message}</td></tr>`; 
            } else {
                showNotification('Error al cargar más historial: ' + error.message, 'error');
            }
        } finally {
            isHistoryLoadingMore = false;
            historyPaginationLoadingMessage.style.display = 'none';
            if (!historyHasMoreItems && transactionsHistoryTableBody.children.length > 0) {
                showNotification('Todo el historial de transacciones ha sido cargado.', 'info');
            }
        }
    }

    function renderTransactionsHistoryTable(transactionsToRender, appendMode = false) {
        if (!appendMode) { 
            transactionsHistoryTableBody.innerHTML = '';
        }

        let html = '';
        transactionsToRender.forEach(t => {
            const insumoNombre = t.insumo_nombre_display; // Ya procesado en fetchAndRenderNextHistoryPage
            const loteInfo = t.lote_info_display; // Ya procesado en fetchAndRenderNextHistoryPage
            const insumoNombre = t.insumo_nombre_display; 
            const loteInfo = t.lote_info_display; 
            const tipoClass = t.tipo === 'entrada' ? 'entrada' : (t.tipo === 'salida' ? 'salida' : 'ajuste');

            // Determinar si mostrar el botón de eliminar
            const deleteButtonHtml = isAdmin ? 
                `<button class="btn-delete btn-delete-history" data-id="${t.id}" title="Eliminar transacción">
                    <span class="material-symbols-outlined">delete</span>
                </button>` : '';

            html += `
                <tr>
                    <td data-label="Fecha">${formatDateTime(t.created_at?.toDate ? t.created_at.toDate() : t.created_at)}</td> <td data-label="Insumo">${insumoNombre}</td>
                    <td data-label="Fecha">${formatDateTime(t.created_at?.toDate ? t.created_at.toDate() : t.created_at)}</td> 
                    <td data-label="Insumo">${insumoNombre}</td>
                    <td data-label="Lote">${loteInfo}</td>
                    <td data-label="Tipo" class="transaction-type ${tipoClass}">${t.tipo.charAt(0).toUpperCase() + t.tipo.slice(1)}</td>
                    <td data-label="Cantidad">${t.cantidad}</td>
                    <td data-label="Responsable">${t.responsable || 'Desconocido'}</td>
                    <td data-label="Acciones" class="action-buttons">${deleteButtonHtml}</td> </tr>
                    <td data-label="Responsable">${t.responsable_display}</td> <td data-label="Acciones" class="action-buttons">${deleteButtonHtml}</td> 
                </tr>
            `;
        });
        transactionsHistoryTableBody.insertAdjacentHTML('beforeend', html);
    }

    // --- Lógica de Eliminación de Historial ---
    transactionsHistoryTableBody.addEventListener('click', async (e) => {
        const deleteButton = e.target.closest('.btn-delete-history');
        if (deleteButton && isAdmin) { // Solo si es el botón de eliminar y el usuario es admin
        if (deleteButton && isAdmin) { 
            const transactionId = deleteButton.dataset.id;

            if (confirm(`¿Estás seguro de que deseas eliminar esta transacción (ID: ${transactionId})? Esto no revertirá los cambios en el inventario.`)) {
                try {
                    // Eliminar el documento de la transacción de la colección
                    await deleteDoc(doc(db, 'transacciones_inventario', transactionId));
                    showNotification('Transacción eliminada correctamente del historial.', 'success');
                    // Recargar el historial para que se refleje el cambio
                    await resetHistoryPaginationAndLoad(); 
                } catch (error) {
                    console.error('Error al eliminar transacción:', error);
                    showNotification('Error al eliminar transacción: ' + error.message, 'error');
                }
            }
        }
    });


    // --- Listener de Scroll para Historial ---
    window.addEventListener('scroll', () => {
        const documentHeight = document.documentElement.scrollHeight;
        const windowHeight = window.innerHeight;
        const scrollTop = window.scrollY;

        if (scrollTop + windowHeight >= documentHeight - 500 && historyHasMoreItems && !isHistoryLoadingMore) {
            fetchAndRenderNextHistoryPage(false); 
        }
    });

    // Asegurarse de que allInsumosWithLotesCached sea correctamente referenciado
    // La línea `allInsumosWithLsumosCached.forEach(insumo => {` en `loadAllInsumosAndLotesForForm` tenía un typo.
    // Se ha corregido a `allInsumosWithLotesCached.forEach(insumo => {`.
  </script>
</body>
</html>
