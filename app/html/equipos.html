<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LabFlow Manager - Equipos</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  
  <style>
    /* 1. Variables CSS (Copia y pega este bloque en todos tus HTML) */
    :root {
        /* Colores base y de fondo */
        --background-light: #ffffff;
        --background-medium: #f0f4f8;
        --background-dark: #e0e6ec;
        --text-primary: #2c3e50;
        --text-secondary: #607d8b;
        --border-color: #d1d9e6;
        --shadow-color: rgba(0, 0, 0, 0.1);

        --accent-glow-start: rgba(129, 212, 250, 0.6);
        --accent-glow-end: rgba(79, 195, 247, 0.6);
        --accent-primary: #81d4fa;
        --accent-secondary: #4fc3f7;

        --action-success: #66bb6a;
        --action-error: #ef5350;
        --action-info: #42a5f5;
        --action-warning: #ffa726;

        --font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;

        --sidebar-width-collapsed: 60px;
        --sidebar-width-expanded: 240px;
    }

    /* 2. Estilos CSS Globales y Comunes (Copia y pega este bloque en todos tus HTML) */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
        font-family: var(--font-family); /* Usa la nueva fuente */
        background: var(--background-light); /* Fondo principal blanco */
        background-image:
            radial-gradient(ellipse at 10% 90%, var(--accent-glow-start), transparent 50%),
            radial-gradient(ellipse at 90% 10%, var(--accent-glow-end), transparent 50%);
        color: var(--text-primary); /* Texto principal azul oscuro */
        display: flex; /* Para layout de sidebar + contenido */
        min-height: 100vh;
        overflow-x: hidden; /* Evita scroll horizontal */
        animation: fadeIn 1s ease-in-out; /* Animación de entrada suave */
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Estilos para contenedores de página y envoltorios de contenido (reutilizados para modal, etc.) */
    .login-container, .page-container, .main-container, .content-wrapper, #equipmentModalContent, #serviceHistoryModalContent { /* #equipmentModalContent for modal */
        background-color: var(--background-medium);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 30px;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        box-shadow: 0 8px 25px var(--shadow-color);
        transition: transform 0.3s ease;
    }
    @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    h1, h2 { color: var(--text-primary); font-weight: 700; }
    p { color: var(--text-secondary); }

    .btn { font-family: var(--font-family); padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: all 0.3s ease, transform 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .btn-primary { background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary)); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(79, 195, 247, 0.4); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-secondary { background-color: var(--background-dark); color: var(--text-primary); border: 1px solid var(--border-color); }
    .btn-secondary:hover { background-color: #dbe2e9; border-color: #c0c6ce; }
    .btn-edit { background-color: rgba(79, 195, 247, 0.2); color: var(--accent-secondary); }
    .btn-edit:hover { background-color: rgba(79, 195, 247, 0.4); }
    .btn-delete { background-color: rgba(239, 83, 80, 0.2); color: var(--action-error); }
    .btn-delete:hover { background-color: rgba(239, 83, 80, 0.4); }
    .btn-info-action {
        background-color: rgba(66, 165, 245, 0.2);
        color: var(--action-info);
    }
    .btn-info-action:hover {
        background-color: rgba(66, 165, 245, 0.4);
    }

    input[type="text"], input[type="email"], input[type="password"], input[type="number"], input[type="date"], input[type="search"], select, textarea {
        width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--background-dark); color: var(--text-primary); font-size: 1rem; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
    input::placeholder, textarea::placeholder { color: var(--text-secondary); opacity: 0.8; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent-secondary); box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.3); }

    .error-message { color: var(--action-error); font-size: 0.85rem; margin-top: 5px; text-align: left; }

    #app-notification { position: fixed; top: 25px; right: 25px; padding: 12px 25px; border-radius: 8px; color: white; z-index: 2000; opacity: 0; transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; transform: translateX(100%); display: flex; align-items: center; justify-content: center; font-size: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    #app-notification.show { opacity: 1; transform: translateX(0); }
    #app-notification.success { background-color: var(--action-success); }
    #app-notification.error { background-color: var(--action-error); }
    #app-notification.info { background-color: var(--action-info); }

    /* 3. Estilos Específicos para Páginas de Módulo (inventory.html, entradas-salidas.html, users.html, equipos.html, envios.html, productos.html) */
    body {
        display: flex;
        flex-direction: row; /* Sidebar y main en fila */
        align-items: stretch; /* Estira el contenido verticalmente */
        background-image: none; /* Sin glow para un fondo más limpio */
        background-color: var(--background-light); /* Fondo del contenido de la página */
    }

    nav#sidebar {
        width: var(--sidebar-width-collapsed);
        background: var(--background-medium);
        color: var(--text-primary);
        display: flex;
        flex-direction: column;
        transition: width 0.3s ease-in-out;
        position: fixed;
        height: 100vh;
        overflow: hidden;
        z-index: 1000;
        box-shadow: 2px 0 8px var(--shadow-color);
        border-right: 1px solid var(--border-color);
    }
    nav#sidebar:hover {
        width: var(--sidebar-width-expanded);
    }
    nav#sidebar header {
        padding: 1.2rem 1rem;
        font-weight: 700;
        font-size: 0; /* Oculta el texto por defecto */
        user-select: none;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
        background: var(--background-dark);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: font-size 0.3s ease, padding 0.3s ease;
    }
    nav#sidebar:hover header {
        font-size: 1.3rem;
        padding: 1.2rem 1rem;
    }

    #user-info {
        padding: 1rem 1.2rem;
        font-size: 0.9rem;
        border-top: 1px solid var(--border-color);
        text-align: center;
        opacity: 0;
        height: 0;
        overflow: hidden;
        transition: opacity 0.3s ease, height 0.3s ease, padding 0.3s ease;
    }
    nav#sidebar:hover #user-info {
        opacity: 1;
        height: auto;
        padding: 1rem 1.2rem;
    }
    #user-info .material-symbols-outlined {
        font-size: 1.8rem;
        margin-bottom: 0.3rem;
        color: var(--accent-secondary);
    }
    #user-email-display-sidebar {
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--text-secondary);
    }
    #user-logout-btn-sidebar {
        background: var(--background-dark);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.85rem;
        cursor: pointer;
        margin-top: 8px;
        transition: background-color 0.2s ease, border-color 0.2s ease;
    }
    #user-logout-btn-sidebar:hover {
        background-color: rgba(0,0,0,0.1);
        border-color: rgba(0,0,0,0.3);
    }

    nav#sidebar ul {
        list-style: none;
        padding: 0;
        margin: 0;
        flex-grow: 1;
        overflow-y: auto;
    }
    nav#sidebar ul li {
        border-bottom: 1px solid var(--border-color);
    }
    nav#sidebar ul li a {
        display: flex;
        align-items: center;
        color: var(--text-primary);
        text-decoration: none;
        padding: 1rem 1.2rem;
        font-weight: 500;
        transition: background-color 0.3s ease;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    nav#sidebar ul li a:hover {
        background: rgba(0,0,0,0.05);
        color: var(--text-primary);
    }
    nav#sidebar ul li a .material-symbols-outlined {
        margin-right: 0;
        font-size: 1.6rem;
        transition: margin-right 0.3s ease;
    }
    nav#sidebar:hover ul li a .material-symbols-outlined {
        margin-right: 1rem;
    }
    nav#sidebar ul li a span.text {
        display: none;
        transition: opacity 0.3s ease;
        opacity: 0;
        width: 0;
    }
    nav#sidebar:hover ul li a span.text {
        display: inline;
        opacity: 1;
        width: auto;
    }
    
    #btnToggleSidebar { display: none; }


    main#content {
        flex-grow: 1;
        margin-left: var(--sidebar-width-collapsed); /* Margen inicial */
        padding: 2rem 3rem 4rem 3rem;
        transition: margin-left 0.3s ease-in-out;
        background-color: var(--background-light); /* Fondo del contenido de la página */
    }
    nav#sidebar:hover + main#content {
        margin-left: var(--sidebar-width-expanded);
    }

    header.page-header {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        user-select: none;
        color: var(--text-primary);
    }
    #btnBackMenu {
        background: var(--background-dark); /* Botón de regreso */
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        font-size: 1rem;
        padding: 0.6rem 1.2rem;
        border-radius: 8px; /* Más redondeado */
        cursor: pointer;
        user-select: none;
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        margin-bottom: 1.5rem;
        transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    #btnBackMenu:hover {
        background: rgba(0,0,0,0.1); /* Ligeramente más oscuro en hover */
        border-color: rgba(0,0,0,0.3);
    }

    .content-wrapper {
        padding: 30px;
    }

    /* Controles de la tabla (buscador y botones de filtro) */
    .table-controls {
        display: flex;
        flex-wrap: wrap; /* Permite que los elementos se envuelvan en pantallas pequeñas */
        gap: 15px; /* Espacio entre los elementos */
        margin-bottom: 1.5rem;
        align-items: center;
    }
    /* El buscador */
    #searchInput {
        width: 100%;
        max-width: 450px;
        font-size: 1rem;
        padding: 0.7rem 1rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background-color: var(--background-dark);
        color: var(--text-primary);
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    #searchInput:focus {
        outline: none;
        border-color: var(--accent-secondary);
        box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.3);
    }
    /* Contenedor de botones de filtro */
    .filter-buttons-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    /* Estilos generales para tablas dentro de content-wrapper */
    table {
        width: 100%;
        margin-top: 30px;
        border-collapse: separate;
        border-spacing: 0;
        box-shadow: 0 4px 15px var(--shadow-color);
        background: var(--background-medium);
        border-radius: 12px;
        overflow: hidden;
    }
    thead {
        background: var(--background-dark);
        color: var(--text-primary);
        font-weight: 700;
    }
    th, td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.9rem;
        color: var(--text-primary);
    }
    th:first-child { border-top-left-radius: 12px; }
    th:last-child { border-top-right-radius: 12px; }
    tbody tr:last-child td {
        border-bottom: none;
    }
    tr:hover {
        background: rgba(0,0,0,0.05);
        cursor: default;
    }

    /* Estilos específicos para la tabla de equipos */
    .equipos-table th, .equipos-table td {
        /* Puedes añadir estilos específicos aquí si difieren de la tabla general */
    }
    /* Estilos para el estado (activo/inactivo) */
    .status-activo { color: var(--action-success); font-weight: 500; }
    .status-en-mantenimiento { color: var(--action-warning); font-weight: 500; }
    .status-inactivo { color: var(--action-error); font-weight: 500; }


    /* Botones de acción en tablas */
    .action-buttons {
        display: flex;
        gap: 8px;
    }
    .action-buttons .btn {
        padding: 6px 10px;
        font-size: 0.85rem;
        box-shadow: none;
    }
    .action-buttons .btn-edit {
        background-color: rgba(79, 195, 247, 0.2);
        color: var(--accent-secondary);
    }
    .action-buttons .btn-edit:hover {
        background-color: rgba(79, 195, 247, 0.4);
    }
    .action-buttons .btn-delete {
        background-color: rgba(239, 83, 80, 0.2);
        color: var(--action-error);
    }
    .action-buttons .btn-delete:hover {
        background-color: rgba(239, 83, 80, 0.4);
    }
    /* New: Button for "Service History" */
    .action-buttons .btn-info-action {
        background-color: rgba(66, 165, 245, 0.2);
        color: var(--action-info);
    }
    .action-buttons .btn-info-action:hover {
        background-color: rgba(66, 165, 245, 0.4);
    }


    /* Botón Añadir Nuevo Equipo */
    #add-equipment-btn {
        background: var(--accent-primary);
        color: white;
        font-size: 1.1rem;
        padding: 0.8rem 1.8rem;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
    }
    #add-equipment-btn:hover {
        background: var(--accent-secondary);
        transform: translateY(-2px);
    }

    /* Modales (formularios flotantes) */
    .modal-backdrop {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.3);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1500;
        backdrop-filter: blur(8px);
    }
    .modal-backdrop.active {
        display: flex;
    }
    #equipmentModalContent, #serviceHistoryModalContent { /* New ID for service history modal content */
        max-width: 700px; /* Slightly wider for service history */
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
    }
    #equipmentModalContent h2, #serviceHistoryModalContent h2 {
        color: var(--text-primary);
        margin-top: 0;
        margin-bottom: 1.5rem;
        font-size: 1.6rem;
    }
    #equipmentModalContent .form-group label, #serviceHistoryModalContent .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.95rem;
    }
    #equipmentModalContent input, #equipmentModalContent select, #equipmentModalContent textarea,
    #serviceHistoryModalContent input, #serviceHistoryModalContent select, #serviceHistoryModalContent textarea {
        background-color: var(--background-dark);
        color: var(--text-primary);
    }
    .modal-footer {
        margin-top: 25px;
        display: flex;
        justify-content: flex-end;
        gap: 15px;
    }
    .modal-footer .btn-secondary {
        background: var(--background-dark);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
    }
    .modal-footer .btn-secondary:hover {
        background: rgba(0,0,0,0.05);
        border-color: rgba(0,0,0,0.2);
    }
    .modal-footer .btn-primary {
        background: var(--accent-primary);
        color: white;
    }
    .modal-footer .btn-primary:hover {
        background: var(--accent-secondary);
    }
    .close-modal-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: transparent;
        border: none;
        font-size: 2.2rem;
        cursor: pointer;
        color: var(--text-secondary);
        user-select: none;
        transition: color 0.3s ease;
    }
    .close-modal-btn:hover {
        color: var(--text-primary);
    }

    /* Estilos para la tabla de historial de servicio dentro del modal */
    #serviceHistoryTable {
        width: 100%;
        margin-top: 20px;
        border-collapse: separate;
        border-spacing: 0;
        background: var(--background-dark); /* Fondo más oscuro para la tabla dentro del modal */
        border-radius: 12px;
        overflow: hidden;
    }
    #serviceHistoryTable thead {
        background: var(--background-medium); /* Fondo más claro para el thead */
        color: var(--text-primary);
        font-weight: 700;
    }
    #serviceHistoryTable th, #serviceHistoryTable td {
        padding: 10px 12px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.85rem;
        color: var(--text-primary);
    }
    #serviceHistoryTable tbody tr:last-child td {
        border-bottom: none;
    }
    #serviceHistoryTable tbody tr:hover {
        background: rgba(0,0,0,0.03);
    }
    #serviceHistoryTable .empty-message {
        background: transparent;
    }


    /* Mensajes de carga/vacío/error en tablas */
    .loading-message, .empty-message {
        text-align: center;
        padding: 1.5rem;
        font-style: italic;
        color: var(--text-secondary);
    }
    .error-message { /* Re-uso de la clase error-message global para tablas */
        color: var(--action-error);
        text-align: center;
        padding: 1.5rem;
    }

    @media (max-width: 768px) {
        main#content {
            padding: 1.5rem;
        }
        .content-wrapper {
            padding: 20px;
        }
        .table-controls {
            flex-direction: column;
            align-items: stretch;
            gap: 15px;
        }
        .table-controls h2 {
            font-size: 1.4rem;
        }
        table thead { display: none; }
        table tr {
            display: block;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            background-color: var(--background-medium);
        }
        table td {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: none;
            align-items: center;
        }
        table td::before {
            content: attr(data-label);
            font-weight: bold;
            color: var(--text-secondary);
            flex-shrink: 0;
            margin-right: 10px;
        }
        table td:last-child {
            justify-content: flex-end;
            margin-top: 10px;
        }
        #equipmentModalContent, #serviceHistoryModalContent { /* General modal content for responsiveness */
            max-width: 95%;
            padding: 20px;
        }
        #serviceHistoryTable th, #serviceHistoryTable td {
            font-size: 0.75rem; /* Smaller font for small screens */
            padding: 8px 10px;
        }
    }
  </style>
</head>
<body>
  <nav id="sidebar" aria-label="Menú lateral">
    <header>LabFlow Manager</header>
    <ul>
      <li><a href="home.html"><span class="material-symbols-outlined">home</span> <span class="text">Inicio</span></a></li>
      <li><a href="inventory.html"><span class="material-symbols-outlined">inventory_2</span> <span class="text">Insumos</span></a></li>
      <li><a href="entradas-salidas.html"><span class="material-symbols-outlined">fact_check</span> <span class="text">Entradas/Salidas</span></a></li>
      <li><a href="envios.html"><span class="material-symbols-outlined">send</span> <span class="text">Envíos</span></a></li>
      <li><a href="users.html"><span class="material-symbols-outlined">groups</span> <span class="text">Usuarios</span></a></li>
      <li><a href="equipos.html"><span class="material-symbols-outlined">build</span> <span class="text">Equipos</span></a></li>
      <li><a href="reportes.html"><span class="material-symbols-outlined">bar_chart</span> <span class="text">Reportes</span></a></li>
    </ul>
    <div id="user-info">
        <span class="material-symbols-outlined">account_circle</span>
        <div id="user-email-display-sidebar">Verificando sesión...</div> 
        <button id="user-logout-btn-sidebar" class="btn-secondary">Cerrar Sesión</button> 
    </div>
  </nav>

  <main id="content" tabindex="-1">
    <header class="page-header">Gestión de Equipos</header>
    <button id="btnBackMenu" class="btn-secondary" title="Volver al menú principal">← Volver al menú</button>

    <div class="content-wrapper">
        <div class="table-controls">
            <h2 class="section-title" style="margin-bottom: 0;">Todos los equipos</h2>
            <button id="add-equipment-btn" class="btn btn-primary">
                <span class="material-symbols-outlined">add_box</span> Añadir Nuevo Equipo
            </button>
        </div>
        
        <table class="equipos-table">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Modelo</th>
                    <th>No. Serie</th>
                    <th>Ubicación</th>
                    <th>Estado</th>
                    <th>Fecha Adquisición</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="equipments-table-body">
                <tr class="loading-message"><td colspan="7">Cargando equipos...</td></tr>
                </tbody>
        </table>
    </div>

    <div class="modal-backdrop" id="equipmentModal">
        <div class="modal-content" id="equipmentModalContent">
            <h2 id="equipmentModalTitle">Añadir Nuevo Equipo</h2>
            <button type="button" class="close-modal-btn material-symbols-outlined">close</button>
            <form id="equipmentForm">
                <input type="hidden" id="equipment-id-field">
                
                <div class="form-group">
                    <label for="nombre-field">Nombre del Equipo:</label>
                    <input type="text" id="nombre-field" required placeholder="Ej. Centrifugadora">
                    <div class="error-message" id="error-nombre"></div>
                </div>
                <div class="form-group">
                    <label for="modelo-field">Modelo:</label>
                    <input type="text" id="modelo-field" placeholder="Ej. Modelo X-2000">
                </div>
                <div class="form-group">
                    <label for="numero-serie-field">Número de Serie:</label>
                    <input type="text" id="numero-serie-field" placeholder="Ej. SN-123456">
                    <div class="error-message" id="error-numero-serie"></div>
                </div>
                <div class="form-group">
                    <label for="ubicacion-field">Ubicación Actual:</label>
                    <input type="text" id="ubicacion-field" placeholder="Ej. Laboratorio 1, Mesa B">
                </div>
                <div class="form-group">
                    <label for="estado-field">Estado:</label>
                    <select id="estado-field" required>
                        <option value="activo">Activo</option>
                        <option value="en mantenimiento">En Mantenimiento</option>
                        <option value="inactivo">Inactivo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="fecha-adquisicion-field">Fecha de Adquisición:</label>
                    <input type="date" id="fecha-adquisicion-field">
                </div>
                <div class="form-group full-width">
                    <label for="descripcion-field">Descripción:</label>
                    <textarea id="descripcion-field" rows="3" placeholder="Características, especificaciones"></textarea>
                </div>
                <div class="form-group full-width">
                    <label for="comentarios-field">Comentarios Adicionales:</label>
                    <textarea id="comentarios-field" rows="3" placeholder="Notas sobre el equipo"></textarea>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary close-modal-btn">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="save-equipment-btn">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-backdrop" id="serviceHistoryModal">
        <div class="modal-content" id="serviceHistoryModalContent">
            <h2 id="serviceHistoryModalTitle">Historial de Servicio para: <span id="currentEquipmentName"></span></h2>
            <button type="button" class="close-modal-btn material-symbols-outlined">close</button>
            
            <form id="addServiceRecordForm">
                <h3>Añadir Nuevo Registro de Servicio</h3>
                <input type="hidden" id="service-equipment-id-field">
                <div class="form-group">
                    <label for="fecha-servicio-field">Fecha de Servicio:</label>
                    <input type="date" id="fecha-servicio-field" required>
                    <div class="error-message" id="error-fecha-servicio"></div>
                </div>
                <div class="form-group">
                    <label for="tipo-servicio-field">Tipo de Servicio:</label>
                    <input type="text" id="tipo-servicio-field" required placeholder="Ej. Mantenimiento Preventivo, Calibración">
                    <div class="error-message" id="error-tipo-servicio"></div>
                </div>
                <div class="form-group full-width">
                    <label for="detalles-servicio-field">Detalles del Servicio:</label>
                    <textarea id="detalles-servicio-field" rows="3" placeholder="Descripción de trabajos realizados, repuestos"></textarea>
                    <div class="error-message" id="error-detalles-servicio"></div>
                </div>
                <div class="form-group">
                    <label for="realizado-por-field">Realizado por:</label>
                    <input type="text" id="realizado-por-field" placeholder="Nombre del técnico o proveedor">
                </div>
                <div class="form-group">
                    <label for="costo-servicio-field">Costo (USD):</label>
                    <input type="number" id="costo-servicio-field" min="0" step="0.01" value="0">
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" id="save-service-record-btn">Guardar Registro</button>
                </div>
            </form>

            <h3 style="margin-top: 30px;">Registros de Servicio Anteriores</h3>
            <table id="serviceHistoryTable">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Tipo de Servicio</th>
                        <th>Detalles</th>
                        <th>Realizado por</th>
                        <th>Costo</th>
                    </tr>
                </thead>
                <tbody id="service-records-table-body">
                    <tr class="empty-message"><td colspan="5">No hay registros de servicio.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
  </main>

  <script type="module">
    // --- Firebase SDKs ---
    // IMPORTANTE: Asegúrate de que la versión del SDK (ej. 10.12.0) sea la más reciente
    // y consistente en todos tus archivos HTML.
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { 
        getFirestore, 
        collection, 
        query, 
        orderBy, 
        getDocs, 
        doc, 
        addDoc, 
        updateDoc, 
        deleteDoc,
        where, // Para filtrar registros de servicio por equipo_id
        writeBatch // Para eliminar múltiples registros de servicio
    } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    // ** TU OBJETO firebaseConfig DE LA CONSOLA DE FIREBASE **
    // REEMPLAZA estos valores con los que obtuviste al configurar tu proyecto Firebase.
    const firebaseConfig = {
      apiKey: "AIzaSyCxJOpBEXZUo7WrAqDTrlJV_2kJBsL8Ym0",
      authDomain: "labflow-manager.firebaseapp.com",
      projectId: "labflow-manager",
      storageBucket: "labflow-manager.firebasestorage.app",
      messagingSenderId: "742212306654",
      appId: "1:742212306654:web:a53bf890fc63cd5d05e44f",
      measurementId: "G-YVZDBCJR3B"
    };

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app); // Instancia para la autenticación
    const db = getFirestore(app); // Instancia para la base de datos Firestore

    // --- Elementos DOM Comunes ---
    const btnBackMenu = document.getElementById('btnBackMenu');
    const userEmailDisplaySidebar = document.getElementById('user-email-display-sidebar');
    const userLogoutBtnSidebar = document.getElementById('user-logout-btn-sidebar');
    // Global notification div (se crea si no existe)
    let notificationDiv = document.getElementById('app-notification');
    if (!notificationDiv) {
        notificationDiv = document.createElement('div');
        notificationDiv.id = 'app-notification';
        document.body.appendChild(notificationDiv);
    }

    // --- Elementos DOM de Gestión de Equipos ---
    const equipmentsTableBody = document.getElementById('equipments-table-body');
    const addEquipmentBtn = document.getElementById('add-equipment-btn');

    // Modal de Equipo (Add/Edit)
    const equipmentModal = document.getElementById('equipmentModal');
    const equipmentModalTitle = document.getElementById('equipmentModalTitle');
    const equipmentForm = document.getElementById('equipmentForm');
    const equipmentIdField = document.getElementById('equipment-id-field');
    const nombreField = document.getElementById('nombre-field');
    const modeloField = document.getElementById('modelo-field');
    const numeroSerieField = document.getElementById('numero-serie-field');
    const ubicacionField = document.getElementById('ubicacion-field');
    const estadoField = document.getElementById('estado-field');
    const fechaAdquisicionField = document.getElementById('fecha-adquisicion-field');
    const descripcionField = document.getElementById('descripcion-field');
    const comentariosField = document.getElementById('comentarios-field');
    const saveEquipmentBtn = document.getElementById('save-equipment-btn');
    const closeModalBtnsEquipment = equipmentModal.querySelectorAll('.close-modal-btn');

    // Errores del formulario de Equipo
    const errorNombre = document.getElementById('error-nombre');
    const errorNumeroSerie = document.getElementById('error-numero-serie');

    let isEditingEquipment = false;

    // --- Elementos DOM de Historial de Servicio ---
    const serviceHistoryModal = document.getElementById('serviceHistoryModal');
    const serviceHistoryModalTitle = document.getElementById('serviceHistoryModalTitle');
    const currentEquipmentName = document.getElementById('currentEquipmentName');
    const addServiceRecordForm = document.getElementById('addServiceRecordForm');
    const serviceEquipmentIdField = document.getElementById('service-equipment-id-field');
    const fechaServicioField = document.getElementById('fecha-servicio-field');
    const tipoServicioField = document.getElementById('tipo-servicio-field');
    const detallesServicioField = document.getElementById('detalles-servicio-field');
    const realizadoPorField = document.getElementById('realizado-por-field');
    const costoServicioField = document.getElementById('costo-servicio-field');
    const saveServiceRecordBtn = document.getElementById('save-service-record-btn');
    const serviceRecordsTableBody = document.getElementById('service-records-table-body');
    const closeModalBtnsServiceHistory = serviceHistoryModal.querySelectorAll('.close-modal-btn');

    // Errores del formulario de Servicio
    const errorFechaServicio = document.getElementById('error-fecha-servicio');
    const errorTipoServicio = document.getElementById('error-tipo-servicio');
    const errorDetallesServicio = document.getElementById('error-detalles-servicio');


    // --- Funciones de Utilidad ---
    function formatDateTime(dateTimeString) {
        if (!dateTimeString) return 'N/A';
        try {
            return new Date(dateTimeString).toLocaleString('es-MX', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        } catch (e) {
            console.warn("Fecha/hora inválida para formatear:", dateTimeString, e);
            return dateTimeString;
        }
    }
    function formatFecha(dateString) { // Formatea AAAA-MM-DD a DD/MM/YYYY
        if (!dateString) return 'N/A';
        try {
            const date = new Date(dateString);
            if (isNaN(date)) {
                console.warn("Fecha inválida para formatear:", dateString);
                return dateString;
            }
            return date.toLocaleDateString('es-MX', { year: 'numeric', month: '2-digit', day: '2-digit' });
        } catch (e) {
            console.error("Error al formatear fecha:", dateString, e);
            return dateString;
        }
    }
    function showNotification(message, type = 'info') {
        notificationDiv.textContent = message;
        notificationDiv.className = '';
        notificationDiv.classList.add(type);
        notificationDiv.classList.add('show');
        setTimeout(() => { notificationDiv.classList.remove('show'); }, 3000);
    }

    // --- Control de Modales ---
    function openModal(modalElement) {
        modalElement.classList.add('active');
    }

    function closeModalAndResetForm(modalElement, formElement) {
        modalElement.classList.remove('active');
        formElement.reset();
    }

    function openEquipmentModal() {
        equipmentForm.reset();
        clearEquipmentFormErrors();
        equipmentIdField.value = '';
        isEditingEquipment = false;
        equipmentModalTitle.textContent = 'Añadir Nuevo Equipo';
        saveEquipmentBtn.textContent = 'Guardar';
        openModal(equipmentModal);
        setTimeout(() => nombreField.focus(), 50);
    }

    function closeEquipmentModal() {
        closeModalAndResetForm(equipmentModal, equipmentForm);
    }

    function openServiceHistoryModal() {
        addServiceRecordForm.reset();
        clearServiceFormErrors();
        fechaServicioField.value = new Date().toISOString().slice(0, 10); // Default to today's date
        costoServicioField.value = 0; // Default cost to 0
        serviceRecordsTableBody.innerHTML = '<tr class="empty-message"><td colspan="5">Cargando registros...</td></tr>'; // Show loading message
        openModal(serviceHistoryModal);
        setTimeout(() => fechaServicioField.focus(), 50);
    }

    function closeServiceHistoryModal() {
        closeModalAndResetForm(serviceHistoryModal, addServiceRecordForm);
    }

    // Event listeners para cerrar modales
    closeModalBtnsEquipment.forEach(btn => {
        btn.addEventListener('click', closeEquipmentModal);
    });
    equipmentModal.addEventListener('click', (e) => {
        if (e.target === equipmentModal) { closeEquipmentModal(); }
    });

    closeModalBtnsServiceHistory.forEach(btn => {
        btn.addEventListener('click', closeServiceHistoryModal);
    });
    serviceHistoryModal.addEventListener('click', (e) => {
        if (e.target === serviceHistoryModal) { closeServiceHistoryModal(); }
    });


    // --- Autenticación Firebase ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userName = user.displayName || user.email;
            userEmailDisplaySidebar.textContent = userName;
            console.log('Sesión activa de Firebase restaurada para:', user.email);
            await fetchEquipments(); // Cargar equipos una vez que la sesión esté verificada
        } else {
            console.log('No hay sesión activa de Firebase o ha sido cerrada. Redirigiendo al login...');
            window.location.href = 'index.html';
        }
    });

    async function handleLogout() {
        try {
            await signOut(auth); // Cierra la sesión de Firebase
            console.log('Sesión cerrada correctamente.');
        } catch (error) {
            console.error('Error al cerrar sesión:', error.message);
            showNotification('Error al cerrar sesión: ' + error.message, 'error');
        }
    }
    document.getElementById('user-logout-btn-sidebar').addEventListener('click', handleLogout);

    // --- Lógica de Gestión de Equipos (Firestore) ---

    async function fetchEquipments() {
        equipmentsTableBody.innerHTML = `<tr class="loading-message"><td colspan="7">Cargando equipos...</td></tr>`;
        try {
            const equiposCollection = collection(db, 'equipos');
            const q = query(equiposCollection, orderBy('nombre', 'asc'));
            const querySnapshot = await getDocs(q);

            const equipos = [];
            querySnapshot.forEach(doc => {
                equipos.push({ id: doc.id, ...doc.data() });
            });

            if (equipos.length === 0) {
                equipmentsTableBody.innerHTML = `<tr class="empty-message"><td colspan="7">No hay equipos registrados.</td></tr>`;
                return;
            }

            renderEquipmentsTable(equipos);

        } catch (error) {
            console.error("Error al obtener equipos:", error);
            equipmentsTableBody.innerHTML = `<tr class="error-message"><td colspan="7">Error al cargar equipos: ${error.message}</td></tr>`;
            showNotification('Error al cargar equipos.', 'error');
        }
    }

    function renderEquipmentsTable(equipos) {
        let html = '';
        equipos.forEach(equipo => {
            let statusClass = '';
            switch (equipo.estado) {
                case 'activo':
                    statusClass = 'status-activo';
                    break;
                case 'en mantenimiento':
                    statusClass = 'status-en-mantenimiento';
                    break;
                case 'inactivo':
                    statusClass = 'status-inactivo';
                    break;
                default:
                    statusClass = '';
            }
            const fechaAdquisicionDisplay = equipo.fecha_adquisicion ? formatFecha(equipo.fecha_adquisicion) : 'N/A';

            html += `
                <tr>
                    <td data-label="Nombre">${equipo.nombre}</td>
                    <td data-label="Modelo">${equipo.modelo || 'N/A'}</td>
                    <td data-label="No. Serie">${equipo.numero_serie || 'N/A'}</td>
                    <td data-label="Ubicación">${equipo.ubicacion || 'N/A'}</td>
                    <td data-label="Estado" class="${statusClass}">${equipo.estado.charAt(0).toUpperCase() + equipo.estado.slice(1)}</td>
                    <td data-label="Fecha Adquisición">${fechaAdquisicionDisplay}</td>
                    <td data-label="Acciones">
                        <div class="action-buttons">
                            <button class="btn btn-info-action" 
                                data-id="${equipo.id}" 
                                data-nombre="${equipo.nombre}" 
                                title="Ver historial de servicio">
                                <span class="material-symbols-outlined">history</span>
                            </button>
                            <button class="btn btn-edit" 
                                data-id="${equipo.id}" 
                                data-nombre="${equipo.nombre}" 
                                data-modelo="${equipo.modelo || ''}" 
                                data-numero-serie="${equipo.numero_serie || ''}" 
                                data-ubicacion="${equipo.ubicacion || ''}" 
                                data-estado="${equipo.estado}" 
                                data-fecha-adquisicion="${equipo.fecha_adquisicion || ''}" 
                                data-descripcion="${equipo.descripcion || ''}" 
                                data-comentarios="${equipo.comentarios || ''}" 
                                title="Editar equipo">
                                <span class="material-symbols-outlined">edit</span>
                            </button>
                            <button class="btn btn-delete" 
                                data-id="${equipo.id}" 
                                data-nombre="${equipo.nombre}" 
                                title="Eliminar equipo">
                                <span class="material-symbols-outlined">delete</span>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        equipmentsTableBody.innerHTML = html;

        // Attach event listeners to action buttons using delegation
        equipmentsTableBody.addEventListener('click', (e) => {
            const targetButton = e.target.closest('.btn');
            if (!targetButton) return;

            const equipmentId = targetButton.dataset.id;
            const equipmentName = targetButton.dataset.nombre;

            if (targetButton.classList.contains('btn-info-action')) {
                handleViewServiceHistory(equipmentId, equipmentName);
            } else if (targetButton.classList.contains('btn-edit')) {
                handleEditEquipment(targetButton.dataset); // Pass all dataset attributes
            } else if (targetButton.classList.contains('btn-delete')) {
                handleDeleteEquipment(equipmentId, equipmentName);
            }
        });
    }

    // --- Form Validation (Equipo) ---
    function clearEquipmentFormErrors() {
        errorNombre.textContent = '';
        errorNumeroSerie.textContent = '';
    }

    function validateEquipmentForm() {
        clearEquipmentFormErrors();
        let isValid = true;

        const nombre = nombreField.value.trim();
        const numeroSerie = numeroSerieField.value.trim();

        if (!nombre) { errorNombre.textContent = 'El nombre del equipo es obligatorio.'; isValid = false; }
        if (!numeroSerie) { errorNumeroSerie.textContent = 'El número de serie es obligatorio.'; isValid = false; }
        // Add more validation if needed, e.g., check for unique serial number before saving

        return isValid;
    }

    // --- Equipment Actions (Add/Edit/Delete) (Firestore) ---
    addEquipmentBtn.addEventListener('click', openEquipmentModal); // Llama a la función de abrir modal

    equipmentForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        saveEquipmentBtn.disabled = true;

        if (!validateEquipmentForm()) {
            saveEquipmentBtn.disabled = false;
            showNotification('Por favor, corrige los errores del formulario.', 'error');
            return;
        }

        const equipmentData = {
            nombre: nombreField.value.trim(),
            modelo: modeloField.value.trim() || null,
            numero_serie: numeroSerieField.value.trim(),
            ubicacion: ubicacionField.value.trim() || null,
            estado: estadoField.value,
            fecha_adquisicion: fechaAdquisicionField.value || null, // AAAA-MM-DD
            descripcion: descripcionField.value.trim() || null,
            comentarios: comentariosField.value.trim() || null,
            created_at: new Date().toISOString() // Timestamp de creación
        };

        try {
            if (isEditingEquipment) {
                const equipmentDocRef = doc(db, 'equipos', equipmentIdField.value);
                await updateDoc(equipmentDocRef, equipmentData);
                showNotification('Equipo actualizado correctamente.', 'success');
            } else {
                await addDoc(collection(db, 'equipos'), equipmentData);
                showNotification('Equipo añadido correctamente.', 'success');
            }
            
            closeEquipmentModal(); // Cierra y resetea el modal
            await fetchEquipments(); // Recarga la lista de equipos
        } catch (error) {
            console.error('Error al guardar equipo:', error);
            showNotification(`Error al guardar equipo: ${error.message}`, 'error');
        } finally {
            saveEquipmentBtn.disabled = false;
        }
    });

    function handleEditEquipment(data) {
        isEditingEquipment = true;
        equipmentModalTitle.textContent = 'Editar Equipo';
        saveEquipmentBtn.textContent = 'Actualizar';
        
        // Populate form fields from dataset
        equipmentIdField.value = data.id;
        nombreField.value = data.nombre;
        modeloField.value = data.modelo;
        numeroSerieField.value = data.numeroSerie;
        ubicacionField.value = data.ubicacion;
        estadoField.value = data.estado;
        fechaAdquisicionField.value = data.fechaAdquisicion;
        descripcionField.value = data.descripcion;
        comentariosField.value = data.comentarios;
        
        openEquipmentModal(); // Abre el modal en modo edición
        setTimeout(() => nombreField.focus(), 50); // Enfoca el primer campo
    }

    async function handleDeleteEquipment(equipmentId, equipmentName) {
        if (!confirm(`¿Estás seguro de eliminar el equipo "${equipmentName}"? Esta acción es irreversible.`)) {
            return;
        }

        try {
            // First, delete all associated service records for this equipment
            const serviceRecordsQuery = query(collection(db, 'registros_servicio'), where('equipo_id', '==', equipmentId));
            const serviceRecordsSnapshot = await getDocs(serviceRecordsQuery);
            
            if (!serviceRecordsSnapshot.empty) {
                const batch = writeBatch(db); // Use a batch to delete multiple documents atomically
                serviceRecordsSnapshot.forEach(recordDoc => {
                    batch.delete(recordDoc.ref);
                });
                await batch.commit(); // Execute all deletions
                console.log(`Eliminados ${serviceRecordsSnapshot.docs.length} registros de servicio asociados al equipo ${equipmentName}.`);
            }

            // Then, delete the equipment document itself
            await deleteDoc(doc(db, 'equipos', equipmentId));

            showNotification('Equipo y sus registros de servicio eliminados correctamente.', 'success');
            await fetchEquipments(); // Reload the equipment list
        } catch (error) {
            console.error('Error al eliminar equipo:', error);
            showNotification(`Error al eliminar equipo: ${error.message}`, 'error');
        }
    }

    // --- Lógica de Historial de Servicio (Firestore) ---
    async function handleViewServiceHistory(equipmentId, equipmentName) {
        currentEquipmentName.textContent = equipmentName;
        serviceEquipmentIdField.value = equipmentId; // Store the ID of the equipment being serviced
        
        openServiceHistoryModal(); // Abre el modal de historial de servicio
        await fetchServiceRecords(equipmentId); // Carga y muestra los registros de servicio
    }

    async function fetchServiceRecords(equipmentId) {
        serviceRecordsTableBody.innerHTML = '<tr class="loading-message"><td colspan="5">Cargando registros...</td></tr>';
        try {
            const serviceRecordsCollection = collection(db, 'registros_servicio');
            const q = query(serviceRecordsCollection, where('equipo_id', '==', equipmentId), orderBy('fecha_servicio', 'desc'));
            const querySnapshot = await getDocs(q);

            const records = [];
            querySnapshot.forEach(doc => {
                records.push({ id: doc.id, ...doc.data() });
            });

            if (!records || records.length === 0) {
                serviceRecordsTableBody.innerHTML = '<tr class="empty-message"><td colspan="5">No hay registros de servicio para este equipo.</td></tr>';
                return;
            }

            renderServiceRecordsTable(records);

        } catch (error) {
            console.error('Error al obtener registros de servicio:', error);
            serviceRecordsTableBody.innerHTML = `<tr class="error-message"><td colspan="5">Error al cargar registros: ${error.message}</td></tr>`;
            showNotification('Error al cargar registros de servicio.', 'error');
        }
    }

    function renderServiceRecordsTable(records) {
        let html = '';
        records.forEach(record => {
            const fechaServicioDisplay = record.fecha_servicio ? formatFecha(record.fecha_servicio) : 'N/A';
            const costoDisplay = record.costo ? `$${parseFloat(record.costo).toFixed(2)}` : 'N/A';
            html += `
                <tr>
                    <td>${fechaServicioDisplay}</td>
                    <td>${record.tipo_servicio || 'N/A'}</td>
                    <td>${record.detalles || 'N/A'}</td>
                    <td>${record.realizado_por || 'N/A'}</td>
                    <td>${costoDisplay}</td>
                </tr>
            `;
        });
        serviceRecordsTableBody.innerHTML = html;
    }

    // --- Form Validation (Registro de Servicio) ---
    function clearServiceFormErrors() {
        errorFechaServicio.textContent = '';
        errorTipoServicio.textContent = '';
        errorDetallesServicio.textContent = '';
    }

    function validateServiceForm() {
        clearServiceFormErrors();
        let isValid = true;

        const fechaServicio = fechaServicioField.value;
        const tipoServicio = tipoServicioField.value.trim();
        const detallesServicio = detallesServicioField.value.trim();

        if (!fechaServicio) { errorFechaServicio.textContent = 'La fecha de servicio es obligatoria.'; isValid = false; }
        if (!tipoServicio) { errorTipoServicio.textContent = 'El tipo de servicio es obligatorio.'; isValid = false; }
        if (!detallesServicio) { errorDetallesServicio.textContent = 'Los detalles del servicio son obligatorios.'; isValid = false; }

        if (fechaServicio && new Date(fechaServicio) > new Date()) {
            errorFechaServicio.textContent = 'La fecha de servicio no puede ser futura.'; isValid = false;
        }

        return isValid;
    }

    // --- Add Service Record Action ---
    addServiceRecordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        saveServiceRecordBtn.disabled = true;

        if (!validateServiceForm()) {
            saveServiceRecordBtn.disabled = false;
            showNotification('Por favor, corrige los errores del formulario de servicio.', 'error');
            return;
        }

        const serviceRecordData = {
            equipo_id: serviceEquipmentIdField.value,
            fecha_servicio: fechaServicioField.value || null,
            tipo_servicio: tipoServicioField.value.trim(),
            detalles: detallesServicioField.value.trim(),
            realizado_por: realizadoPorField.value.trim() || null,
            costo: costoServicioField.value ? parseFloat(costoServicioField.value) : 0,
            registrado_por: document.getElementById('user-email-display-sidebar').textContent, // Usuario logueado
            created_at: new Date().toISOString() // Timestamp de creación
        };

        try {
            await addDoc(collection(db, 'registros_servicio'), serviceRecordData);

            showNotification('Registro de servicio añadido correctamente.', 'success');
            addServiceRecordForm.reset(); // Clear form after successful add
            fechaServicioField.value = new Date().toISOString().slice(0, 10); // Reset date
            costoServicioField.value = 0; // Reset cost
            await fetchServiceRecords(serviceRecordData.equipo_id); // Reload service history for current equipment

        } catch (error) {
            console.error('Error al añadir registro de servicio:', error);
            showNotification(`Error al añadir registro de servicio: ${error.message}`, 'error');
        } finally {
            saveServiceRecordBtn.disabled = false;
        }
    });

    // --- Carga Inicial ---
    // window.addEventListener('load', () => { }); // onAuthStateChanged se encarga de la verificación de sesión y llamada a fetchEquipments
  </script>
</body>
</html>
