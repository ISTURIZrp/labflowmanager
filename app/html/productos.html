<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LabFlow Manager - Productos</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

  <style>
    /* 1. Variables CSS (Copia y pega este bloque en todos tus HTML) */
    :root {
        --background-light: #ffffff;
        --background-medium: #f0f4f8;
        --background-dark: #e0e6ec;
        --text-primary: #2c3e50;
        --text-secondary: #607d8b;
        --border-color: #d1d9e6;
        --shadow-color: rgba(0, 0, 0, 0.1);

        --accent-glow-start: rgba(129, 212, 250, 0.6);
        --accent-glow-end: rgba(79, 195, 247, 0.6);
        --accent-primary: #81d4fa;
        --accent-secondary: #4fc3f7;

        --action-success: #66bb6a;
        --action-error: #ef5350;
        --action-info: #42a5f5;
        --action-warning: #ffa726;

        --font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;

        --sidebar-width-collapsed: 60px;
        --sidebar-width-expanded: 240px;
    }

    /* 2. Estilos CSS Globales y Comunes (Copia y pega este bloque en todos tus HTML) */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
        font-family: var(--font-family);
        background: var(--background-light);
        background-image:
            radial-gradient(ellipse at 10% 90%, var(--accent-glow-start), transparent 50%),
            radial-gradient(ellipse at 90% 10%, var(--accent-glow-end), transparent 50%);
        color: var(--text-primary);
        display: flex;
        min-height: 100vh;
        overflow-x: hidden;
        animation: fadeIn 1s ease-in-out;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .login-container, .page-container, .main-container, .content-wrapper, #productModalContent, #placeOrderModalContent { /* #placeOrderModalContent for new modal */
        background-color: var(--background-medium);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 30px;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        box-shadow: 0 8px 25px var(--shadow-color);
        transition: transform 0.3s ease;
    }
    @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    h1, h2 { color: var(--text-primary); font-weight: 700; }
    p { color: var(--text-secondary); }

    .btn { font-family: var(--font-family); padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: all 0.3s ease, transform 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .btn-primary { background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary)); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(79, 195, 247, 0.4); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-secondary { background-color: var(--background-dark); color: var(--text-primary); border: 1px solid var(--border-color); }
    .btn-secondary:hover { background-color: #dbe2e9; border-color: #c0c6ce; }
    .btn-edit { background-color: rgba(79, 195, 247, 0.2); color: var(--accent-secondary); }
    .btn-edit:hover { background-color: rgba(79, 195, 247, 0.4); }
    .btn-delete { background-color: rgba(239, 83, 80, 0.2); color: var(--action-error); }
    .btn-delete:hover { background-color: rgba(239, 83, 80, 0.4); }
    .btn-info-action {
        background-color: rgba(66, 165, 245, 0.2);
        color: var(--action-info);
    }
    .btn-info-action:hover {
        background-color: rgba(66, 165, 245, 0.4);
    }
    .btn-order { /* Specific style for the "Place Order" button */
        background-color: var(--action-success);
        color: white;
    }
    .btn-order:hover {
        background-color: #5cb85c;
    }


    input[type="text"], input[type="email"], input[type="password"], input[type="number"], input[type="date"], input[type="search"], select, textarea {
        width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--background-dark); color: var(--text-primary); font-size: 1rem; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
    input::placeholder, textarea::placeholder { color: var(--text-secondary); opacity: 0.8; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent-secondary); box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.3); }

    .error-message { color: var(--action-error); font-size: 0.85rem; margin-top: 5px; text-align: left; }

    #app-notification { position: fixed; top: 25px; right: 25px; padding: 12px 25px; border-radius: 8px; color: white; z-index: 2000; opacity: 0; transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; transform: translateX(100%); display: flex; align-items: center; justify-content: center; font-size: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    #app-notification.show { opacity: 1; transform: translateX(0); }
    #app-notification.success { background-color: var(--action-success); }
    #app-notification.error { background-color: var(--action-error); }
    #app-notification.info { background-color: var(--action-info); }

    /* 3. Estilos Específicos para Páginas de Módulo (inventory.html, entradas-salidas.html, users.html, equipos.html, envios.html, productos.html) */
    body {
        display: flex;
        flex-direction: row; /* Sidebar y main en fila */
        align-items: stretch; /* Estira el contenido verticalmente */
        background-image: none; /* Sin glow para un fondo más limpio */
        background-color: var(--background-light); /* Fondo del contenido de la página */
    }

    nav#sidebar {
        width: var(--sidebar-width-collapsed);
        background: var(--background-medium);
        color: var(--text-primary);
        display: flex;
        flex-direction: column;
        transition: width 0.3s ease-in-out;
        position: fixed;
        height: 100vh;
        overflow: hidden;
        z-index: 1000;
        box-shadow: 2px 0 8px var(--shadow-color);
        border-right: 1px solid var(--border-color);
    }
    nav#sidebar:hover {
        width: var(--sidebar-width-expanded);
    }
    nav#sidebar header {
        padding: 1.2rem 1rem;
        font-weight: 700;
        font-size: 0; /* Oculta el texto por defecto */
        user-select: none;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
        background: var(--background-dark);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: font-size 0.3s ease, padding 0.3s ease;
    }
    nav#sidebar:hover header {
        font-size: 1.3rem;
        padding: 1.2rem 1rem;
    }

    #user-info {
        padding: 1rem 1.2rem;
        font-size: 0.9rem;
        border-top: 1px solid var(--border-color);
        text-align: center;
        opacity: 0;
        height: 0;
        overflow: hidden;
        transition: opacity 0.3s ease, height 0.3s ease, padding 0.3s ease;
    }
    nav#sidebar:hover #user-info {
        opacity: 1;
        height: auto;
        padding: 1rem 1.2rem;
    }
    #user-info .material-symbols-outlined {
        font-size: 1.8rem;
        margin-bottom: 0.3rem;
        color: var(--accent-secondary);
    }
    #user-email-display-sidebar {
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--text-secondary);
    }
    #user-logout-btn-sidebar {
        background: var(--background-dark);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.85rem;
        cursor: pointer;
        margin-top: 8px;
        transition: background-color 0.2s ease, border-color 0.2s ease;
    }
    #user-logout-btn-sidebar:hover {
        background-color: rgba(0,0,0,0.1);
        border-color: rgba(0,0,0,0.3);
    }

    nav#sidebar ul {
        list-style: none;
        padding: 0;
        margin: 0;
        flex-grow: 1;
        overflow-y: auto;
    }
    nav#sidebar ul li {
        border-bottom: 1px solid var(--border-color);
    }
    nav#sidebar ul li a {
        display: flex;
        align-items: center;
        color: var(--text-primary);
        text-decoration: none;
        padding: 1rem 1.2rem;
        font-weight: 500;
        transition: background-color 0.3s ease;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    nav#sidebar ul li a:hover {
        background: rgba(0,0,0,0.05);
        color: var(--text-primary);
    }
    nav#sidebar ul li a .material-symbols-outlined {
        margin-right: 0;
        font-size: 1.6rem;
        transition: margin-right 0.3s ease;
    }
    nav#sidebar:hover ul li a .material-symbols-outlined {
        margin-right: 1rem;
    }
    nav#sidebar ul li a span.text {
        display: none;
        transition: opacity 0.3s ease;
        opacity: 0;
        width: 0;
    }
    nav#sidebar:hover ul li a span.text {
        display: inline;
        opacity: 1;
        width: auto;
    }

    #btnToggleSidebar { display: none; }


    main#content {
        flex-grow: 1;
        margin-left: var(--sidebar-width-collapsed);
        padding: 2rem 3rem 4rem 3rem;
        transition: margin-left 0.3s ease-in-out;
        background-color: var(--background-light);
    }
    nav#sidebar:hover + main#content {
        margin-left: var(--sidebar-width-expanded);
    }

    header.page-header {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        user-select: none;
        color: var(--text-primary);
    }
    #btnBackMenu {
        background: var(--background-dark);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        font-size: 1rem;
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        cursor: pointer;
        user-select: none;
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        margin-bottom: 1.5rem;
        transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    #btnBackMenu:hover {
        background: rgba(0,0,0,0.1);
        border-color: rgba(0,0,0,0.3);
    }

    .content-wrapper {
        padding: 30px;
    }

    /* Buscador (Se mantiene para consistencia, aunque no todas las páginas lo usen) */
    #searchInput {
        width: 100%;
        max-width: 450px;
        font-size: 1rem;
        padding: 0.7rem 1rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background-color: var(--background-dark);
        color: var(--text-primary);
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    #searchInput:focus {
        outline: none;
        border-color: var(--accent-secondary);
        box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.3);
    }

    /* Estilos generales para tablas dentro de content-wrapper */
    table {
        width: 100%;
        margin-top: 30px;
        border-collapse: separate;
        border-spacing: 0;
        box-shadow: 0 4px 15px var(--shadow-color);
        background: var(--background-medium);
        border-radius: 12px;
        overflow: hidden;
    }
    thead {
        background: var(--background-dark);
        color: var(--text-primary);
        font-weight: 700;
    }
    th, td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.9rem;
        color: var(--text-primary);
    }
    th:first-child { border-top-left-radius: 12px; }
    th:last-child { border-top-right-radius: 12px; }
    tbody tr:last-child td {
        border-bottom: none;
    }
    tr:hover {
        background: rgba(0,0,0,0.05);
        cursor: default;
    }

    /* Estilos específicos para la tabla de productos */
    .productos-table th, .productos-table td {
        /* Puedes añadir estilos específicos aquí si difieren de la tabla general */
    }
    /* Estilos para el estado (activo/inactivo) */
    .status-activo { color: var(--action-success); font-weight: 500; }
    .status-inactivo { color: var(--action-error); font-weight: 500; }


    /* Botones de acción en tablas */
    .action-buttons {
        display: flex;
        gap: 8px;
    }
    .action-buttons .btn {
        padding: 6px 10px;
        font-size: 0.85rem;
        box-shadow: none;
    }
    .action-buttons .btn-edit {
        background-color: rgba(79, 195, 247, 0.2);
        color: var(--accent-secondary);
    }
    .action-buttons .btn-edit:hover {
        background-color: rgba(79, 195, 247, 0.4);
    }
    .action-buttons .btn-delete {
        background-color: rgba(239, 83, 80, 0.2);
        color: var(--action-error);
    }
    .action-buttons .btn-delete:hover {
        background-color: rgba(239, 83, 80, 0.4);
    }
    /* New: Button for "Place Order" or similar */
    .action-buttons .btn-order-action { /* Custom style for order button */
        background-color: rgba(102, 187, 106, 0.2); /* Soft green background */
        color: var(--action-success); /* Green text */
    }
    .action-buttons .btn-order-action:hover {
        background-color: rgba(102, 187, 106, 0.4);
    }


    /* Botón Añadir Nuevo Producto */
    #add-product-btn {
        background: var(--accent-primary);
        color: white;
        font-size: 1.1rem;
        padding: 0.8rem 1.8rem;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
    }
    #add-product-btn:hover {
        background: var(--accent-secondary);
        transform: translateY(-2px);
    }

    /* Modales (formularios flotantes) */
    .modal-backdrop {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.3);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1500;
        backdrop-filter: blur(8px);
    }
    .modal-backdrop.active {
        display: flex;
    }
    #productModalContent, #placeOrderModalContent { /* New ID for place order modal content */
        max-width: 650px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
    }
    #productModalContent h2, #placeOrderModalContent h2 {
        color: var(--text-primary);
        margin-top: 0;
        margin-bottom: 1.5rem;
        font-size: 1.6rem;
    }
    #productModalContent .form-group label, #placeOrderModalContent .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.95rem;
    }
    #productModalContent input, #productModalContent select, #productModalContent textarea,
    #placeOrderModalContent input, #placeOrderModalContent select, #placeOrderModalContent textarea {
        background-color: var(--background-dark);
        color: var(--text-primary);
    }
    .modal-footer {
        margin-top: 25px;
        display: flex;
        justify-content: flex-end;
        gap: 15px;
    }
    .modal-footer .btn-secondary {
        background: var(--background-dark);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
    }
    .modal-footer .btn-secondary:hover {
        background: rgba(0,0,0,0.05);
        border-color: rgba(0,0,0,0.2);
    }
    .modal-footer .btn-primary {
        background: var(--accent-primary);
        color: white;
    }
    .modal-footer .btn-primary:hover {
        background: var(--accent-secondary);
    }
    .close-modal-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: transparent;
        border: none;
        font-size: 2.2rem;
        cursor: pointer;
        color: var(--text-secondary);
        user-select: none;
        transition: color 0.3s ease;
    }
    .close-modal-btn:hover {
        color: var(--text-primary);
    }

    /* Mensajes de carga/vacío/error en tablas */
    .loading-message, .empty-message {
        text-align: center;
        padding: 1.5rem;
        font-style: italic;
        color: var(--text-secondary);
    }
    .error-message { /* Re-uso de la clase error-message global para tablas */
        color: var(--action-error);
        text-align: center;
        padding: 1.5rem;
    }

    @media (max-width: 768px) {
        main#content {
            padding: 1.5rem;
        }
        .content-wrapper {
            padding: 20px;
        }
        .table-controls {
            flex-direction: column;
            align-items: stretch;
            gap: 15px;
        }
        .table-controls h2 {
            font-size: 1.4rem;
        }
        table thead { display: none; }
        table tr {
            display: block;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            background-color: var(--background-medium);
        }
        table td {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: none;
            align-items: center;
        }
        table td::before {
            content: attr(data-label);
            font-weight: bold;
            color: var(--text-secondary);
            flex-shrink: 0;
            margin-right: 10px;
        }
        table td:last-child {
            justify-content: flex-end;
            margin-top: 10px;
        }
        #productModalContent, #placeOrderModalContent { /* General modal content for responsiveness */
            max-width: 95%;
            padding: 20px;
        }
    }
  </style>
</head>
<body>
  <nav id="sidebar" aria-label="Menú lateral">
    <header>LabFlow Manager</header>
    <ul>
      <li><a href="home.html"><span class="material-symbols-outlined">home</span> <span class="text">Inicio</span></a></li>
      <li><a href="inventory.html"><span class="material-symbols-outlined">inventory_2</span> <span class="text">Insumos</span></a></li>
      <li><a href="productos.html"><span class="material-symbols-outlined">category</span> <span class="text">Productos</span></a></li>
      <li><a href="entradas-salidas.html"><span class="material-symbols-outlined">swap_horiz</span> <span class="text">Entradas/Salidas</span></a></li>
      <li><a href="envios.html"><span class="material-symbols-outlined">local_shipping</span> <span class="text">Envíos</span></a></li>
      <li><a href="equipos.html"><span class="material-symbols-outlined">precision_manufacturing</span> <span class="text">Equipos</span></a></li>
      <li><a href="users.html"><span class="material-symbols-outlined">group</span> <span class="text">Usuarios</span></a></li>
      <li><a href="reportes.html"><span class="material-symbols-outlined">bar_chart</span> <span class="text">Reportes</span></a></li>
    </ul>
    <div id="user-info">
        <span class="material-symbols-outlined">account_circle</span>
        <div id="user-email-display-sidebar">Verificando sesión...</div> 
        <button id="user-logout-btn-sidebar" class="btn-secondary">Cerrar Sesión</button> 
    </div>
  </nav>

  <main id="content" tabindex="-1">
    <header class="page-header">Gestión de Productos</header>
    <button id="btnBackMenu" class="btn-secondary" title="Volver al menú principal">← Volver al menú</button>

    <div class="content-wrapper">
        <div class="table-controls">
            <h2 class="section-title" style="margin-bottom: 0;">Todos los productos</h2>
            <button id="add-product-btn" class="btn btn-primary">
                <span class="material-symbols-outlined">add_box</span> Añadir Nuevo Producto
            </button>
        </div>

        <table class="productos-table">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>SKU</th>
                    <th>Existencia</th>
                    <th>Stock Mínimo</th>
                    <th>Precio</th>
                    <th>Ubicación</th>
                    <th>Activo</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="productos-table-body">
                <tr class="loading-message"><td colspan="8">Cargando productos...</td></tr>
                </tbody>
        </table>
    </div>

    <div class="modal-backdrop" id="productModal">
        <div class="modal-content" id="productModalContent">
            <h2 id="productModalTitle">Añadir Nuevo Producto</h2>
            <button type="button" class="close-modal-btn material-symbols-outlined">close</button>
            <form id="productForm">
                <input type="hidden" id="product-id-field">

                <div class="form-group">
                    <label for="nombre-field">Nombre del Producto:</label>
                    <input type="text" id="nombre-field" required placeholder="Ej. Kit de Análisis Rápido">
                    <div class="error-message" id="error-nombre"></div>
                </div>
                <div class="form-group">
                    <label for="codigo-sku-field">Código SKU:</label>
                    <input type="text" id="codigo-sku-field" placeholder="Ej. LFM-K-001">
                    <div class="error-message" id="error-codigo-sku"></div>
                </div>
                <div class="form-group full-width">
                    <label for="descripcion-field">Descripción:</label>
                    <textarea id="descripcion-field" rows="3" placeholder="Descripción detallada del producto"></textarea>
                </div>
                <div class="form-group">
                    <label for="precio-field">Precio:</label>
                    <input type="number" id="precio-field" min="0" step="0.01">
                    <div class="error-message" id="error-precio"></div>
                </div>
                <div class="form-group">
                    <label for="unidad-medida-field">Unidad de Medida:</label>
                    <input type="text" id="unidad-medida-field" placeholder="Ej. Caja, Unidad">
                </div>
                <div class="form-group">
                    <label for="existencia-actual-field">Existencia Actual:</label>
                    <input type="number" id="existencia-actual-field" min="0" step="1" required>
                    <div class="error-message" id="error-existencia-actual"></div>
                </div>
                <div class="form-group">
                    <label for="stock-minimo-field">Stock Mínimo:</label>
                    <input type="number" id="stock-minimo-field" min="0" step="1" required>
                    <div class="error-message" id="error-stock-minimo"></div>
                </div>
                <div class="form-group">
                    <label for="ubicacion-almacen-field">Ubicación de Almacén:</label>
                    <input type="text" id="ubicacion-almacen-field" placeholder="Ej. Almacén A, Estante 3">
                </div>
                <div class="form-group">
                    <label for="activo-field">Activo:</label>
                    <select id="activo-field" required>
                        <option value="true">Sí</option>
                        <option value="false">No</option>
                    </select>
                    <div class="error-message" id="error-activo"></div>
                </div>
                <div class="form-group full-width">
                    <label for="comentarios-field">Comentarios:</label>
                    <textarea id="comentarios-field" rows="3" placeholder="Notas adicionales"></textarea>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary close-modal-btn">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="save-product-btn">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-backdrop" id="placeOrderModal">
        <div class="modal-content" id="placeOrderModalContent">
            <h2 id="placeOrderModalTitle">Realizar Pedido: <span id="currentProductName"></span></h2>
            <button type="button" class="close-modal-btn material-symbols-outlined">close</button>
            <form id="placeOrderForm">
                <input type="hidden" id="order-product-id-field">

                <div class="form-group">
                    <label for="order-cantidad-field">Cantidad a Pedir:</label>
                    <input type="number" id="order-cantidad-field" min="1" required>
                    <div class="error-message" id="error-order-cantidad"></div>
                </div>
                <div class="form-group">
                    <label for="order-destinatario-field">Destinatario:</label>
                    <input type="text" id="order-destinatario-field" required placeholder="Nombre o Institución">
                    <div class="error-message" id="error-order-destinatario"></div>
                </div>
                <div class="form-group full-width">
                    <label for="order-direccion-envio-field">Dirección de Envío:</label>
                    <input type="text" id="order-direccion-envio-field" required placeholder="Calle, número, colonia, ciudad, CP">
                    <div class="error-message" id="error-order-direccion-envio"></div>
                </div>
                <div class="form-group">
                    <label for="order-contacto-destinatario-field">Contacto Destinatario (Tel/Email):</label>
                    <input type="text" id="order-contacto-destinatario-field" placeholder="Opcional">
                </div>
                <div class="form-group">
                    <label for="order-paqueteria-field">Paquetería:</label>
                    <input type="text" id="order-paqueteria-field" placeholder="Ej. DHL, FedEx">
                </div>
                <div class="form-group">
                    <label for="order-referencia-field">Referencia (ej. N° Orden):</label>
                    <input type="text" id="order-referencia-field" placeholder="Opcional">
                </div>
                <div class="form-group full-width">
                    <label for="order-comentarios-field">Comentarios del Pedido/Envío:</label>
                    <textarea id="order-comentarios-field" rows="3" placeholder="Notas adicionales del pedido/envío"></textarea>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary close-modal-btn">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="save-order-btn">Realizar Pedido</button>
                </div>
            </form>
        </div>
    </div>
  </main>

  <script type="module">
    // --- Firebase SDKs ---
    // IMPORTANTE: Asegúrate de que la versión del SDK (ej. 10.12.0) sea la más reciente
    // y consistente en todos tus archivos HTML (index.html, productos.html, home.html, inventory.html).
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { 
        getFirestore, 
        collection, 
        query, 
        orderBy, 
        getDocs, 
        doc, 
        addDoc, 
        updateDoc, 
        deleteDoc 
    } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    // ** TU OBJETO firebaseConfig DE LA CONSOLA DE FIREBASE **
    // REEMPLAZA estos valores con los que obtuviste al configurar tu proyecto Firebase.
    const firebaseConfig = {
      apiKey: "AIzaSyCxJOpBEXZUo7WrAqDTrlJV_2kJBsL8Ym0",
      authDomain: "labflow-manager.firebaseapp.com",
      projectId: "labflow-manager",
      storageBucket: "labflow-manager.firebasestorage.app",
      messagingSenderId: "742212306654",
      appId: "1:742212306654:web:a53bf890fc63cd5d05e44f",
      measurementId: "G-YVZDBCJR3B"
    };

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app); // Instancia para la autenticación
    const db = getFirestore(app); // Instancia para la base de datos Firestore


    // --- Elementos DOM Comunes ---
    const btnBackMenu = document.getElementById('btnBackMenu');
    const userEmailDisplaySidebar = document.getElementById('user-email-display-sidebar');
    const userLogoutBtnSidebar = document.getElementById('user-logout-btn-sidebar');
    // Global notification div (se crea si no existe)
    let notificationDiv = document.getElementById('app-notification');
    if (!notificationDiv) {
        notificationDiv = document.createElement('div');
        notificationDiv.id = 'app-notification';
        document.body.appendChild(notificationDiv);
    }

    // --- Elementos DOM de Gestión de Productos ---
    const productosTableBody = document.getElementById('productos-table-body');
    const addProductBtn = document.getElementById('add-product-btn'); // Botón Añadir Nuevo Producto

    // Modal de Producto (Add/Edit)
    const productModal = document.getElementById('productModal');
    const productModalTitle = document.getElementById('productModalTitle');
    const productForm = document.getElementById('productForm');
    const productIdField = document.getElementById('product-id-field');
    const nombreField = document.getElementById('nombre-field');
    const codigoSkuField = document.getElementById('codigo-sku-field');
    const descripcionField = document.getElementById('descripcion-field');
    const precioField = document.getElementById('precio-field');
    const unidadMedidaField = document.getElementById('unidad-medida-field');
    const existenciaActualField = document.getElementById('existencia-actual-field');
    const stockMinimoField = document.getElementById('stock-minimo-field');
    const ubicacionAlmacenField = document.getElementById('ubicacion-almacen-field');
    const activoField = document.getElementById('activo-field');
    const comentariosField = document.getElementById('comentarios-field');
    const saveProductBtn = document.getElementById('save-product-btn');
    const closeModalBtnsProduct = productModal.querySelectorAll('.close-modal-btn'); // Botones de cerrar del modal de producto

    // Errores del formulario de Producto
    const errorNombre = document.getElementById('error-nombre');
    const errorCodigoSku = document.getElementById('error-codigo-sku');
    const errorPrecio = document.getElementById('error-precio');
    const errorExistenciaActual = document.getElementById('error-existencia-actual');
    const errorStockMinimo = document.getElementById('error-stock-minimo');
    const errorActivo = document.getElementById('error-activo');

    let isEditingProduct = false; // Flag para determinar modo añadir/editar


    // --- Elementos DOM de Realizar Pedido (New) ---
    const placeOrderModal = document.getElementById('placeOrderModal');
    const placeOrderModalTitle = document.getElementById('placeOrderModalTitle');
    const currentProductName = document.getElementById('currentProductName');
    const placeOrderForm = document.getElementById('placeOrderForm');
    const orderProductIdField = document.getElementById('order-product-id-field');
    const orderCantidadField = document.getElementById('order-cantidad-field');
    const orderDestinatarioField = document.getElementById('order-destinatario-field');
    const orderDireccionEnvioField = document.getElementById('order-direccion-envio-field');
    const orderContactoDestinatarioField = document.getElementById('order-contacto-destinatario-field');
    const orderComentariosField = document.getElementById('order-comentarios-field');
    const orderPaqueteriaField = document.getElementById('order-paqueteria-field');
    const orderReferenciaField = document.getElementById('order-referencia-field');
    const saveOrderBtn = document.getElementById('save-order-btn');
    const closeModalBtnsOrder = placeOrderModal.querySelectorAll('.close-modal-btn'); // Botones de cerrar del modal de pedido

    // Errores del formulario de Pedido
    const errorOrderCantidad = document.getElementById('error-order-cantidad');
    const errorOrderDestinatario = document.getElementById('error-order-destinatario');
    const errorOrderDireccionEnvio = document.getElementById('error-order-direccion-envio');


    // --- Funciones de Utilidad ---
    function formatDateTime(dateTimeString) {
        if (!dateTimeString) return 'N/A';
        const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' };
        return new Date(dateTimeString).toLocaleString('es-MX', options);
    }
    // Simple notification system (reutilizado)
    function showNotification(message, type = 'info') {
        notificationDiv.textContent = message;
        notificationDiv.className = '';
        notificationDiv.classList.add(type);
        notificationDiv.classList.add('show');
        setTimeout(() => { notificationDiv.classList.remove('show'); }, 3000);
    }

    // --- Control de Modales ---
    function openModal(modalElement) {
        modalElement.classList.add('active');
    }

    function closeModalAndResetForm(modalElement, formElement) {
        modalElement.classList.remove('active');
        formElement.reset();
    }

    // --- Funciones específicas de apertura y cierre de modales de Producto ---
    function openProductModal() {
        productForm.reset();
        clearProductFormErrors();
        productIdField.value = '';
        isEditingProduct = false;
        productModalTitle.textContent = 'Añadir Nuevo Producto';
        saveProductBtn.textContent = 'Guardar';
        openModal(productModal);
        setTimeout(() => nombreField.focus(), 50);
    }

    function closeProductModal() {
        closeModalAndResetForm(productModal, productForm);
    }

    // --- Funciones específicas de apertura y cierre de modales de Pedido ---
    function openPlaceOrderModal() {
        placeOrderForm.reset();
        clearPlaceOrderFormErrors();
        // orderProductIdField se llenará en handlePlaceOrder
        placeOrderModalTitle.textContent = 'Realizar Pedido:'; // Name will be added by JS
        saveOrderBtn.textContent = 'Realizar Pedido';
        openModal(placeOrderModal);
        setTimeout(() => orderCantidadField.focus(), 50);
    }

    function closePlaceOrderModal() {
        closeModalAndResetForm(placeOrderModal, placeOrderForm);
        currentProductName.textContent = ''; // Clear product name in title
    }

    // Event listeners para los botones de cerrar modal de Producto
    closeModalBtnsProduct.forEach(btn => {
        btn.addEventListener('click', closeProductModal);
    });
    productModal.addEventListener('click', (e) => {
        if (e.target === productModal) { closeProductModal(); }
    });

    // Event listeners para los botones de cerrar modal de Pedido
    closeModalBtnsOrder.forEach(btn => {
        btn.addEventListener('click', closePlaceOrderModal);
    });
    placeOrderModal.addEventListener('click', (e) => {
        if (e.target === placeOrderModal) { closePlaceOrderModal(); }
    });


    // --- Autenticación Firebase ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userName = user.displayName || user.email;
            userEmailDisplaySidebar.textContent = userName;
            console.log('Sesión activa de Firebase restaurada para:', user.email);
            await fetchProductos(); // Cargar productos una vez que la sesión esté verificada
        } else {
            console.log('No hay sesión activa de Firebase o ha sido cerrada. Redirigiendo al login...');
            window.location.href = 'index.html';
        }
    });

    async function handleLogout() {
        try {
            await signOut(auth); // Cierra la sesión de Firebase
            console.log('Sesión cerrada correctamente.');
        } catch (error) {
            console.error('Error al cerrar sesión:', error.message);
            showNotification('Error al cerrar sesión: ' + error.message, 'error');
        }
    }
    document.getElementById('user-logout-btn-sidebar').addEventListener('click', handleLogout);

    // --- Lógica de Gestión de Productos (Firestore) ---

    async function fetchProductos() {
        productosTableBody.innerHTML = `<tr class="loading-message"><td colspan="8">Cargando productos...</td></tr>`;
        try {
            const productsCollection = collection(db, 'productos');
            const q = query(productsCollection, orderBy('nombre', 'asc'));
            const querySnapshot = await getDocs(q);

            const productos = [];
            querySnapshot.forEach((doc) => {
                productos.push({ id: doc.id, ...doc.data() });
            });

            if (productos.length === 0) {
                productosTableBody.innerHTML = `<tr class="empty-message"><td colspan="8">No hay productos registrados.</td></tr>`;
                return;
            }

            renderProductosTable(productos);

        } catch (error) {
            console.error("Error al obtener productos:", error);
            productosTableBody.innerHTML = `<tr class="error-message"><td colspan="8">Error al cargar productos: ${error.message}</td></tr>`;
            showNotification('Error al cargar productos.', 'error');
        }
    }

    function renderProductosTable(productos) {
        let html = '';
        productos.forEach(producto => {
            const activoDisplay = producto.activo ? '<span class="status-activo">Sí</span>' : '<span class="status-inactivo">No</span>';
            const existenciaDisplay = `${producto.existencia_actual} ${producto.unidad_medida || ''}`;

            html += `
                <tr>
                    <td data-label="Nombre">${producto.nombre}</td>
                    <td data-label="SKU">${producto.codigo_sku || 'N/A'}</td>
                    <td data-label="Existencia">${existenciaDisplay}</td>
                    <td data-label="Stock Mínimo">${producto.stock_minimo ?? '0'}</td>
                    <td data-label="Precio">$${parseFloat(producto.precio).toFixed(2)}</td>
                    <td data-label="Ubicación">${producto.ubicacion_almacen || 'N/A'}</td>
                    <td data-label="Activo">${activoDisplay}</td>
                    <td data-label="Acciones">
                        <div class="action-buttons">
                            <button class="btn btn-order-action" 
                                data-id="${producto.id}" 
                                data-nombre="${producto.nombre}" 
                                data-existencia="${producto.existencia_actual}"
                                data-unidad-medida="${producto.unidad_medida || ''}"
                                data-precio="${producto.precio}"
                                data-descripcion-contenido="${producto.descripcion || ''}"
                                title="Realizar pedido">
                                <span class="material-symbols-outlined">send</span>
                            </button>
                            <button class="btn btn-edit" 
                                data-id="${producto.id}" 
                                data-nombre="${producto.nombre}" 
                                data-codigo-sku="${producto.codigo_sku || ''}" 
                                data-descripcion="${producto.descripcion || ''}" 
                                data-precio="${producto.precio || '0'}" 
                                data-unidad-medida="${producto.unidad_medida || ''}" 
                                data-existencia-actual="${producto.existencia_actual}" 
                                data-stock-minimo="${producto.stock_minimo}" 
                                data-ubicacion-almacen="${producto.ubicacion_almacen || ''}" 
                                data-activo="${producto.activo}" 
                                data-comentarios="${producto.comentarios || ''}" 
                                title="Editar producto">
                                <span class="material-symbols-outlined">edit</span>
                            </button>
                            <button class="btn btn-delete" 
                                data-id="${producto.id}" 
                                data-nombre="${producto.nombre}" 
                                title="Eliminar producto">
                                <span class="material-symbols-outlined">delete</span>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        productosTableBody.innerHTML = html;

        // Attach event listeners to action buttons using delegation
        productosTableBody.addEventListener('click', (e) => {
            const targetButton = e.target.closest('.btn');
            if (!targetButton) return;

            const productId = targetButton.dataset.id;
            const productName = targetButton.dataset.nombre;

            if (targetButton.classList.contains('btn-order-action')) {
                handlePlaceOrder(targetButton.dataset); // Handle the new order button
            } else if (targetButton.classList.contains('btn-edit')) {
                handleEditProduct(targetButton.dataset); // Pass all dataset attributes
            } else if (targetButton.classList.contains('btn-delete')) {
                handleDeleteProduct(productId, productName);
            }
        });
    }

    // --- Form Validation (Producto) ---
    function clearProductFormErrors() {
        errorNombre.textContent = '';
        errorCodigoSku.textContent = '';
        errorPrecio.textContent = '';
        errorExistenciaActual.textContent = '';
        errorStockMinimo.textContent = '';
        errorActivo.textContent = '';
    }

    function validateProductForm() {
        clearProductFormErrors();
        let isValid = true;

        const nombre = nombreField.value.trim();
        const codigoSku = codigoSkuField.value.trim();
        const precio = precioField.value;
        const existenciaActual = existenciaActualField.value;
        const stockMinimo = stockMinimoField.value;
        const activo = activoField.value;

        if (!nombre) { errorNombre.textContent = 'El nombre del producto es obligatorio.'; isValid = false; }
        // SKU es UNIQUE en BD, pero no requerido en el HTML si es opcional.
        // Si fuera requerido, aquí se validaría if (!codigoSku) ...
        if (precio === '' || isNaN(precio) || Number(precio) < 0) {
            errorPrecio.textContent = 'El precio debe ser un número positivo o cero.'; isValid = false;
        }
        if (existenciaActual === '' || isNaN(existenciaActual) || Number(existenciaActual) < 0) {
            errorExistenciaActual.textContent = 'La existencia debe ser un número positivo o cero.'; isValid = false;
        }
        if (stockMinimo === '' || isNaN(stockMinimo) || Number(stockMinimo) < 0) {
            errorStockMinimo.textContent = 'El stock mínimo debe ser un número positivo o cero.'; isValid = false;
        }
        if (activo === '') { errorActivo.textContent = 'Activo es obligatorio.'; isValid = false; }


        return isValid;
    }

    // --- Product Actions (Add/Edit/Delete) (Firestore) ---
    addProductBtn.addEventListener('click', openProductModal); // Llama a la función de abrir modal

    productForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        saveProductBtn.disabled = true;

        if (!validateProductForm()) {
            saveProductBtn.disabled = false;
            showNotification('Por favor, corrige los errores del formulario.', 'error');
            return;
        }

        const productData = {
            nombre: nombreField.value.trim(),
            codigo_sku: codigoSkuField.value.trim() || null,
            descripcion: descripcionField.value.trim() || null,
            precio: precioField.value ? parseFloat(precioField.value) : 0,
            unidad_medida: unidadMedidaField.value.trim() || null,
            existencia_actual: parseInt(existenciaActualField.value),
            stock_minimo: parseInt(stockMinimoField.value),
            ubicacion_almacen: ubicacionAlmacenField.value.trim() || null,
            activo: activoField.value === 'true', // Convert string to boolean
            comentarios: comentariosField.value.trim() || null,
            created_at: new Date().toISOString() // Añadir timestamp de creación
        };

        try {
            if (isEditingProduct) {
                const productId = productIdField.value;
                const productDocRef = doc(db, 'productos', productId);
                await updateDoc(productDocRef, productData);
                showNotification('Producto actualizado correctamente.', 'success');
            } else {
                await addDoc(collection(db, 'productos'), productData);
                showNotification('Producto añadido correctamente.', 'success');
            }

            closeProductModal(); // Cierra y resetea el modal
            await fetchProductos(); // Recarga la lista de productos
        } catch (error) {
            console.error('Error al guardar producto:', error);
            showNotification(`Error al guardar producto: ${error.message}`, 'error');
        } finally {
            saveProductBtn.disabled = false;
        }
    });

    function handleEditProduct(data) {
        isEditingProduct = true;
        productModalTitle.textContent = 'Editar Producto';
        saveProductBtn.textContent = 'Actualizar';

        // Populate form fields from dataset
        productIdField.value = data.id;
        nombreField.value = data.nombre;
        codigoSkuField.value = data.codigoSku;
        descripcionField.value = data.descripcion;
        precioField.value = data.precio;
        unidadMedidaField.value = data.unidadMedida;
        existenciaActualField.value = data.existenciaActual;
        stockMinimoField.value = data.stockMinimo;
        ubicacionAlmacenField.value = data.ubicacionAlmacen;
        activoField.value = String(data.activo); // Convert boolean to string for select
        comentariosField.value = data.comentarios;

        openProductModal(); // Abre el modal en modo edición
        setTimeout(() => nombreField.focus(), 50); // Enfoca el primer campo
    }

    async function handleDeleteProduct(productId, productName) {
        if (!confirm(`¿Estás seguro de eliminar el producto "${productName}"? Esta acción es irreversible.`)) {
            return;
        }

        try {
            await deleteDoc(doc(db, 'productos', productId));
            showNotification('Producto eliminado correctamente.', 'success');
            await fetchProductos(); // Recarga la lista de productos
        } catch (error) {
            console.error('Error al eliminar producto:', error);
            showNotification(`Error al eliminar producto: ${error.message}`, 'error');
        }
    }

    // --- Lógica de Realizar Pedido (Firestore) ---
    async function handlePlaceOrder(data) {
        // Populate modal with product data
        currentProductName.textContent = data.nombre;
        orderProductIdField.value = data.id;
        orderCantidadField.value = '1'; // Default quantity
        // Prefill description and maybe price into comments/reference
        orderComentariosField.value = `Pedido de ${data.cantidad} ${data.unidadMedida || 'unidades'} de ${data.nombre}. Precio unitario: $${parseFloat(data.precio).toFixed(2)}`;
        orderReferenciaField.value = `ORD-${Date.now().toString().slice(-6)}`; // Simple order reference

        // Clear specific order form errors
        clearPlaceOrderFormErrors();

        openPlaceOrderModal();
    }

    function clearPlaceOrderFormErrors() {
        errorOrderCantidad.textContent = '';
        errorOrderDestinatario.textContent = '';
        errorOrderDireccionEnvio.textContent = '';
    }

    function validatePlaceOrderForm() {
        clearPlaceOrderFormErrors();
        let isValid = true;

        const cantidad = parseInt(orderCantidadField.value);
        const destinatario = orderDestinatarioField.value.trim();
        const direccionEnvio = orderDireccionEnvioField.value.trim();

        if (isNaN(cantidad) || cantidad <= 0) {
            errorOrderCantidad.textContent = 'La cantidad debe ser un número positivo.'; isValid = false;
        }
        if (!destinatario) {
            errorOrderDestinatario.textContent = 'El destinatario es obligatorio.'; isValid = false;
        }
        if (!direccionEnvio) {
            errorOrderDireccionEnvio.textContent = 'La dirección de envío es obligatoria.'; isValid = false;
        }

        return isValid;
    }

    placeOrderForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        saveOrderBtn.disabled = true;

        if (!validatePlaceOrderForm()) {
            saveOrderBtn.disabled = false;
            showNotification('Por favor, corrige los errores del formulario de pedido.', 'error');
            return;
        }
        
        // Obtener el email del usuario logeado para el campo 'responsable_envio'
        const currentUser = auth.currentUser;
        const responsableEnvio = currentUser ? currentUser.email : 'desconocido';

        const orderData = {
            producto_id: orderProductIdField.value,
            fecha_envio: new Date().toISOString().slice(0, 10), // Current date in YYYY-MM-DD
            destinatario: orderDestinatarioField.value.trim(),
            direccion_envio: orderDireccionEnvioField.value.trim(),
            contacto_destinatario: orderContactoDestinatarioField.value.trim() || null,
            // Construye la descripción del contenido de manera más robusta
            contenido_descripcion: `${orderCantidadField.value} ${document.querySelector(`[data-id="${orderProductIdField.value}"]`).dataset.unidadMedida || 'unidades'} de ${currentProductName.textContent}`, 
            numero_rastreo: orderReferenciaField.value.trim() || null, // Use reference as initial tracking number
            paqueteria: orderPaqueteriaField.value.trim() || null,
            estado_envio: 'pendiente', // Default status for new orders
            responsable_envio: responsableEnvio, // User who placed the order (Firebase Auth email)
            comentarios: orderComentariosField.value.trim() || null,
            created_at: new Date().toISOString() // Timestamp de creación
        };

        try {
            await addDoc(collection(db, 'envios'), orderData);

            showNotification('Pedido realizado y envío registrado correctamente.', 'success');
            closePlaceOrderModal();
            // Para la deducción de stock, necesitarías leer el producto, actualizarlo y luego escribirlo.
            // Esto es mejor manejarlo con una Cloud Function o una transacción de Firestore si es crítico.
            // Por ahora, solo recargamos la tabla para que se vea el impacto si ya hay una lógica que disminuya el stock.
            await fetchProductos(); 
        } catch (error) {
            console.error('Error al realizar pedido:', error);
            showNotification(`Error al realizar pedido: ${error.message}`, 'error');
        } finally {
            saveOrderBtn.disabled = false;
        }
    });


    // --- Carga Inicial ---
    // window.addEventListener('load', () => { }); // onAuthStateChanged se encarga de esto

  </script>
</body>
</html>
